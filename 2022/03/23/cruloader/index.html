<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="scr1pt"><title>cruloader · scr1pt's blog</title><meta name="description" content="Cruloader1th Stage一到main函数就是一个加密函数，我们编写脚本去恢复

加密函数如下

那么编写解密脚本并patch上去
12345678910111213141516171819202122232425262728293031table = &amp;#x27;abcdefghijkl"><meta name="keywords" content="Blog,博客,Hexo"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="shortcut icon" type="image/x-icon" href="/images/scr1pt.jpg"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/insight.css"><link rel="stylesheet" href="/css/search.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 6.1.0"></head><body><div class="page-top animated fadeInDown"><div class="nav"><li> <a href="/">Home</a></li><li> <a href="/archives">Archives</a></li><li> <a href="/tags">Tags</a></li><li> <a href="/about">About</a></li><li> <a href="/links">Links</a></li></div><div class="information"><div class="nav_right_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li><li><a class="fa fa-search" onclick="openWindow();"></a></li></div><div class="avatar"><img src="/images/scr1pt.jpg"></div></div></div><div class="sidebar animated fadeInDown"><div class="sidebar-top"><div class="logo-title"><div class="title"><img src="/images/scr1pt.jpg" style="width:200px;" alt="favicon"><h3 title=""><a href="/">scr1pt's blog</a></h3><div class="description"><p>my dear virus, please fuck me</p></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/scr1pt-kid"><i class="fa fa-github"></i></a></li><li><a href="mailto:2466811523@qq.com"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="noopener" href="http://sighttp.qq.com/authd?IDKEY=2466811523"><i class="fa fa-qq"></i></a></li></ul></div></div><div class="footer"><div class="p"> <span> 全站CC-BY-SA-3.0 </span><i class="fa fa-star"></i><span> scr1pt</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo </a><span> & </span><span>Anatolo </span></div><div class="beian"></div></div></div><div class="main"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>cruloader</a></h3></div><div class="post-content"><p><h1 id="Cruloader"><a href="#Cruloader" class="headerlink" title="Cruloader"></a>Cruloader</h1><h2 id="1th-Stage"><a href="#1th-Stage" class="headerlink" title="1th Stage"></a>1th Stage</h2><p>一到main函数就是一个加密函数，我们编写脚本去恢复</p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20220118154600222.png" alt="image-20220118154600222"></p>
<p>加密函数如下</p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20220118154712301.png" alt="image-20220118154712301"></p>
<p>那么编写解密脚本并patch上去</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">table = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ01234567890./=&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decode</span>(<span class="params">enc</span>):</span><br><span class="line">    result = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(enc)):</span><br><span class="line">        ind = table.index(enc[i]) + <span class="number">13</span></span><br><span class="line">        <span class="keyword">if</span> ind &gt;= <span class="built_in">len</span>(table):</span><br><span class="line">            ind -= <span class="built_in">len</span>(table)</span><br><span class="line">        result +=table[ind]</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">    ea_start = <span class="number">0x00414880</span></span><br><span class="line">    ea_end = <span class="number">0x00414980</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    tt = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> ea <span class="keyword">in</span> <span class="built_in">range</span>(ea_start,ea_end):</span><br><span class="line">        temp = ida_bytes.get_bytes(ea,<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">ord</span>(temp) == <span class="number">0</span> <span class="keyword">or</span> <span class="built_in">ord</span>(temp) == <span class="number">10</span>:</span><br><span class="line">            <span class="keyword">if</span> tt !=<span class="string">b&#x27;&#x27;</span>:</span><br><span class="line">                dec_str = decode(tt.decode())</span><br><span class="line">                ida_bytes.patch_bytes(ea-<span class="built_in">len</span>(tt),dec_str.encode())</span><br><span class="line">            tt = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">            ea_start = ea</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">            tt += temp</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;ok&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>然后发现Resource中保存有一些加密数据</p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20220118182629205.png" alt="image-20220118182629205"></p>
<p>对应的解密代码段如下，是一个RC4加密的代码段，key为加密代码段的第12byte后的16byte。</p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20220118192018253.png" alt="image-20220118192018253"></p>
<p>解密的数据为key后面的数据,key为<code>kkd5YdPM24VBXmi</code></p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20220118202208420.png" alt="image-20220118202208420"></p>
<h2 id="2th-Stage"><a href="#2th-Stage" class="headerlink" title="2th Stage"></a>2th Stage</h2><p>进一步分析，恶意代码执行流程如下</p>
<p><code>检测反调试 --&gt; 检测进程列表 --&gt; 装载所需的api函数 --&gt; 创建进程svchost.exe --&gt; 把本进程代码注入到svchost.exe中</code></p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20220119163411004.png" alt="image-20220119163411004"></p>
<p>导入注入所需的函数</p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20220119171042249.png" alt="image-20220119171042249"></p>
<p>导入函数使用crc32加密</p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20220120152704911.png" alt="image-20220120152704911"></p>
<h2 id="3th-Stage"><a href="#3th-Stage" class="headerlink" title="3th Stage"></a>3th Stage</h2><p>创建进程</p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20220119171512280.png" alt="image-20220119171512280"></p>
<p>远程代码注入</p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/%E6%88%AA%E5%B1%8F2022-01-19%20%E4%B8%8B%E5%8D%885.25.32.png" alt="截屏2022-01-19 下午5.25.32"></p>
<p>断点命中</p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20220119172645399.png" alt="image-20220119172645399"></p>
<p>首先导入wininet.dll</p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20220119173219597.png" alt="image-20220119173219597"></p>
<p>解密得到url并进行访问</p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20220119173659620.png" alt="image-20220119173659620"></p>
<p>代码是存放在原PE的，我们可以直接找到逻辑</p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20220119182818985.png" alt="image-20220119182818985"></p>
<p>对应的解密逻辑</p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20220119183332890.png" alt="image-20220119183332890"></p>
<p>cyberchef</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://gchq.github.io/CyberChef/#recipe=From_Hex(&#x27;Auto&#x27;)Rotate_left(4,false)XOR(%7B&#x27;option&#x27;:&#x27;Decimal&#x27;,&#x27;string&#x27;:&#x27;197&#x27;%7D,&#x27;Standard&#x27;,false)&amp;input=REExQjFCNUI2QkZGQUVBRTVCNEE2QjFCMEE3QUNBQkFCRTZBQUE4QUFFN0I0QTJCQUU4QTk4MEE4QUNGMTgyOA</span><br></pre></td></tr></table></figure>

<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20220119183319239.png" alt="image-20220119183319239"></p>
<p>访问得到png，再通过访问得到png的数据</p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20220119192017432.png" alt="image-20220119192017432"></p>
<p>然后virtualAlloc申请空间写入PNG</p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20220120135234444.png" alt="image-20220120135234444"></p>
<h2 id="4th-Stage"><a href="#4th-Stage" class="headerlink" title="4th Stage"></a>4th Stage</h2><p>解密得到弹窗的PE代码，但是已经无法解密了（原作者脚本失效）</p>
<h2 id="tips"><a href="#tips" class="headerlink" title="tips"></a>tips</h2><p>ida python脚本编写</p>
<p>由于汇编指令格式如下</p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20220120193336301.png" alt="image-20220120193336301"></p>
<ol>
<li>得到所有函数的crc32表</li>
<li>根据交叉引用和crc32表进行过匹配</li>
<li>输入 comment</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pefile, os, re, binascii</span><br><span class="line"></span><br><span class="line">dlls_list = [<span class="string">&quot;kernel32.dll&quot;</span>, <span class="string">&quot;ntdll.dll&quot;</span>, <span class="string">&quot;wininet.dll&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#Get the list of all functions inside the dll</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_functions</span>(<span class="params">dll_path</span>):</span><br><span class="line">	pe = pefile.PE(dll_path)</span><br><span class="line">	<span class="keyword">if</span> ((<span class="keyword">not</span> <span class="built_in">hasattr</span>(pe, <span class="string">&#x27;DIRECTORY_ENTRY_EXPORT&#x27;</span>)) <span class="keyword">or</span> (pe.DIRECTORY_ENTRY_EXPORT <span class="keyword">is</span> <span class="literal">None</span>)):</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">f&quot;[*] No exports for <span class="subst">&#123;dll_path&#125;</span>&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> []</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		expname = []</span><br><span class="line">		<span class="keyword">for</span> exp <span class="keyword">in</span> pe.DIRECTORY_ENTRY_EXPORT.symbols:</span><br><span class="line">			<span class="keyword">if</span> exp.name:</span><br><span class="line">				expname.append(exp.name)</span><br><span class="line">		<span class="keyword">return</span> expname</span><br><span class="line"></span><br><span class="line"><span class="comment"># Hash the function name</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calc_crc32</span>(<span class="params">string</span>): </span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">int</span>(binascii.crc32(string) &amp; <span class="number">0xFFFFFFFF</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Generate CRC32 lookup table</span></span><br><span class="line">win_path = os.environ[<span class="string">&#x27;WINDIR&#x27;</span>]</span><br><span class="line">system32_path = os.path.join(win_path, <span class="string">&quot;system32&quot;</span>)</span><br><span class="line">data = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> dll <span class="keyword">in</span> dlls_list:</span><br><span class="line">	dll_path = os.path.join(system32_path, dll)</span><br><span class="line">	dll_name = dll.split(<span class="string">&quot;.&quot;</span>)[<span class="number">0</span>].lower()</span><br><span class="line">	<span class="keyword">if</span> os.path.isfile(dll_path):</span><br><span class="line">		<span class="keyword">for</span> f <span class="keyword">in</span> get_functions(dll_path):</span><br><span class="line">			f_name = re.sub(<span class="string">r&#x27;\W+&#x27;</span>, <span class="string">&#x27;_&#x27;</span>, f.decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">			name = <span class="string">&quot;func_&quot;</span>+dll_name + <span class="string">&quot;_&quot;</span> + f_name.lower()</span><br><span class="line">			data[calc_crc32(f)] = name</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">f&quot;[+] Generated functions for <span class="subst">&#123;dll_path&#125;</span>&quot;</span>)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">f&quot;[*] File not found: <span class="subst">&#123;dll_path&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># List all Xref to the function, retrieve the content of edx (where the crc32 hash is) and compare it to our crc32 lookup table. A comment is set if there is a hit</span></span><br><span class="line"><span class="keyword">for</span> xref <span class="keyword">in</span> XrefsTo(get_name_ea_simple(<span class="string">&quot;f_getProcAddr&quot;</span>)):</span><br><span class="line">	currentAddress = <span class="number">0</span></span><br><span class="line">	ea = xref.frm</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">20</span>):</span><br><span class="line">		mnem = print_insn_mnem(prev_head(ea-i))</span><br><span class="line">		<span class="keyword">if</span> mnem == <span class="string">&quot;mov&quot;</span>:</span><br><span class="line">			<span class="keyword">if</span> print_operand(prev_head(ea-i), <span class="number">0</span>) == <span class="string">&quot;edx&quot;</span>:</span><br><span class="line">				crc32_value = print_operand(prev_head(ea-i), <span class="number">1</span>)</span><br><span class="line">				crc32_value = <span class="built_in">int</span>(crc32_value[:-<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">				<span class="keyword">for</span> k, v <span class="keyword">in</span> data.items():</span><br><span class="line">					<span class="keyword">if</span> k == crc32_value:</span><br><span class="line">						set_cmt(xref.frm, v, <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>解密函数</p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20220119154519871.png" alt="image-20220119154519871"></p>
<p>对应着</p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20220119154724772.png" alt="image-20220119154724772"></p>
<p><code>https://gchq.github.io/CyberChef/#recipe=From_Hex(&#39;Auto&#39;)Rotate_left(4,false)XOR(%7B&#39;option&#39;:&#39;Decimal&#39;,&#39;string&#39;:&#39;162&#39;%7D,&#39;Standard&#39;,false)Reverse(&#39;Character&#39;)&amp;input=N0M2RDFEQkQxRkVGMUQ1RERDNkNDQ0JDNUZFRjg5MUVo</code></p>
<h2 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h2><p>收获主要是实现了新线程断点，解决了之前的痛点。熟悉了crc32算法，利用cyberchef解rol，学习了利用交叉引用注释提高代码辨识度的ida python脚本。</p>
<p>缺陷在于仍然无法看懂这段代码，即无法实现静态分析解密处png图片的payload，留坑。</p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20220120153252538.png" alt="image-20220120153252538"></p>
</p><div class="tip">本文采用CC-BY-SA-3.0协议，转载请注明出处<br>Author: scr1pt</div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-03-23</span><i class="fa fa-tag"></i><span class="leancloud_visitors"></span><span>About 934 words, 3 min 6 sec  read</span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://Scr1pt-kid.github.io/2022/03/23/cruloader/,scr1pt's blog,cruloader,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2022/03/23/bokbot-analysis/" title="bokbot-analysis">Previous</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2022/03/23/macos_sample_2.10/" title="simple_macos_analysis">Next</a></li></ul></div><script src="/js/visitors.js"></script></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script>(function(window){var INSIGHT_CONFIG={TRANSLATION:{POSTS:"Posts",PAGES:"Pages",CATEGORIES:"Categories",TAGS:"Tags",UNTITLED:"(Untitled)",},CONTENT_URL:"/content.json",};window.INSIGHT_CONFIG=INSIGHT_CONFIG})(window);</script><script src="/js/insight.js" defer></script><div class="searchbox ins-search"><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"><input class="searchbox-input ins-search-input" type="text" placeholder="Search..."><span class="searchbox-close"><a class="fa fa-times-circle" onclick="closeWindow();"></a></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"><p>Seraching...</p></div></div></div></div></body></html>