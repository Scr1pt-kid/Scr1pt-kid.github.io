<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="scr1pt"><title>Pandora-Ransomeware-fla-unpack · scr1pt's blog</title><meta name="description" content="Pandora Ransomware[TOC]
overviewFirst of all, I love oalabs. Below of code is copied from his research, and I get a lot from just repeat it. And maybe"><meta name="keywords" content="Blog,博客,Hexo"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="shortcut icon" type="image/x-icon" href="/images/scr1pt.jpg"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/insight.css"><link rel="stylesheet" href="/css/search.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 6.1.0"></head><body><div class="page-top animated fadeInDown"><div class="nav"><li> <a href="/">Home</a></li><li> <a href="/archives">Archives</a></li><li> <a href="/tags">Tags</a></li><li> <a href="/about">About</a></li><li> <a href="/links">Links</a></li></div><div class="information"><div class="nav_right_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li><li><a class="fa fa-search" onclick="openWindow();"></a></li></div><div class="avatar"><img src="/images/scr1pt.jpg"></div></div></div><div class="sidebar animated fadeInDown"><div class="sidebar-top"><div class="logo-title"><div class="title"><img src="/images/scr1pt.jpg" style="width:200px;" alt="favicon"><h3 title=""><a href="/">scr1pt's blog</a></h3><div class="description"><p>my dear virus, please fuck me</p></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/scr1pt-kid"><i class="fa fa-github"></i></a></li><li><a href="mailto:2466811523@qq.com"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="noopener" href="http://sighttp.qq.com/authd?IDKEY=2466811523"><i class="fa fa-qq"></i></a></li></ul></div></div><div class="footer"><div class="p"> <span> 全站CC-BY-SA-3.0 </span><i class="fa fa-star"></i><span> scr1pt</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo </a><span> & </span><span>Anatolo </span></div><div class="beian"></div></div></div><div class="main"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Pandora-Ransomeware-fla-unpack</a></h3></div><div class="post-content"><p><h1 id="Pandora-Ransomware"><a href="#Pandora-Ransomware" class="headerlink" title="Pandora Ransomware"></a>Pandora Ransomware</h1><p>[TOC]</p>
<h2 id="overview"><a href="#overview" class="headerlink" title="overview"></a>overview</h2><p>First of all, I love oalabs. Below of code is copied from his research, and I get a lot from just repeat it. And maybe there are also bogus-control-flow in this sample however.</p>
<p>Sample: <code>5b56c5d86347e164c6e571c86dbf5b1535eae6b979fede6ed66b01e79ea33b7b</code></p>
<p>Unpacked sample: <code>2619862c382d3e375f13f3859c6ab44db1a4bce905b4a617df2390fbf36902e7</code> on the malshare(by the oalabs)</p>
<p><strong>References</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://synthesis.to/2021/03/03/flattening_detection.html">Control Flow Flattening</a></li>
<li><a target="_blank" rel="noopener" href="https://research.openanalysis.net/pandora/ransomware/malware/unpacking/dumpulator/emulation/2022/03/19/]https://blog.quarkslab.com/deobfuscation-recovering-an-ollvm-protected-program.html">Deobfuscation - Recovering an ollvm</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mrexodia/dumpulator">dumpulator</a></li>
<li><a target="_blank" rel="noopener" href="https://security.tencent.com/index.php/blog/msg/112">Control Flow Unflattening</a></li>
<li><a target="_blank" rel="noopener" href="https://malshare.com/sample.php?action=detail&hash=5b56c5d86347e164c6e571c86dbf5b1535eae6b979fede6ed66b01e79ea33b7b">malshare</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=SulC2l1Dvbo&t=1s">oalabs</a></li>
</ul>
<span id="more"></span>

<h2 id="Dumpulator"><a href="#Dumpulator" class="headerlink" title="Dumpulator"></a>Dumpulator</h2><blockquote>
<p>according to the jmp [register] </p>
</blockquote>
<p>Our approach is to seperate the dispatcher bb from the payload bb. For each dispatcher bb the code is emulated with all conditions to <code>generate the conditional jump addresses</code>. The bb is then replaced with a simple compare and conditional jmp. Emulation is done with <a target="_blank" rel="noopener" href="https://github.com/mrexodia/dumpulator">Dumpulator</a>.</p>
<p>Once the dispatcher has been deobfuscated we should be able to <code>see the control flow for the payload bb</code>, and futher simplify the dispatcher using more traditional tools, possibly removing it completely.</p>
<ul>
<li>if the jump is relative it’s for a code bb</li>
<li>if the jump is register then it’s a cf bb</li>
<li>if there is a ret this is the end</li>
</ul>
<blockquote>
<p>build a table of bb the start is next head after jmp, end is jmp emulate patch the jmp for each table entry</p>
</blockquote>
<h3 id="IDA-Produce-Basic-Block-Table"><a href="#IDA-Produce-Basic-Block-Table" class="headerlink" title="IDA Produce Basic Block Table"></a>IDA Produce Basic Block Table</h3><p>There are two dispatcher bb formats, <code>one that uses cmovl, cmovz</code>, <code>and one that uses setl and setz</code>. We need to <code>match both patterns</code> and <code>determine the type of condition for our jmp statement</code>, and the eax cmp value. For each bb record the following information so it can be used in our emulator.</p>
<ul>
<li>bb start</li>
<li>bb end</li>
<li>add cmov instruction </li>
<li>type of cmov instruction (l,z)</li>
<li>eax cmp value</li>
<li>jmp register</li>
</ul>
<p>Results: (bb_start, bb_end, eax_value, jmp_condition,jmp_condition_address, jmp_register)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Basic blocks for dispatcher</span></span><br><span class="line">bb_table = []</span><br><span class="line"><span class="comment"># List of addresses of original code basic blocks</span></span><br><span class="line">bb_orig_table = []</span><br><span class="line">ptr = <span class="number">0x00007FF6654A67F0</span></span><br><span class="line">end = <span class="number">0x00007FF6654A70D0</span></span><br><span class="line">bb_start = ptr</span><br><span class="line"><span class="keyword">while</span> ptr &lt;= end:</span><br><span class="line">    <span class="keyword">if</span> print_insn_mnem(ptr) == <span class="string">&#x27;jmp&#x27;</span>:</span><br><span class="line">        op_type = idc.get_operand_type(ptr, <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">if</span> op_type == o_reg:</span><br><span class="line">            <span class="comment"># This is a cf bb save it</span></span><br><span class="line">            reg_name = print_operand(ptr, <span class="number">0</span>)</span><br><span class="line">            <span class="comment"># Get eax value</span></span><br><span class="line">            first_instruction = print_insn_mnem(bb_start)</span><br><span class="line">            <span class="keyword">if</span> first_instruction == <span class="string">&#x27;cmp&#x27;</span>:</span><br><span class="line">                eax_cmp_value = get_operand_value(bb_start,<span class="number">1</span>)</span><br><span class="line">                <span class="comment"># Find cmov instruction</span></span><br><span class="line">                bb_ptr = bb_start</span><br><span class="line">                jmp_condition = <span class="literal">None</span></span><br><span class="line">                jmp_condition_address = <span class="literal">None</span></span><br><span class="line">                <span class="keyword">while</span> bb_ptr &lt; ptr:</span><br><span class="line">                    <span class="keyword">if</span> <span class="string">&#x27;cmovl&#x27;</span> == print_insn_mnem(bb_ptr):</span><br><span class="line">                        jmp_condition = <span class="string">&#x27;cmovl&#x27;</span></span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">elif</span> <span class="string">&#x27;cmovz&#x27;</span> == print_insn_mnem(bb_ptr):</span><br><span class="line">                        jmp_condition = <span class="string">&#x27;cmovz&#x27;</span></span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    bb_ptr  = next_head(bb_ptr)</span><br><span class="line">                jmp_condition_address = bb_ptr</span><br><span class="line">                <span class="comment"># Check results of cmov find</span></span><br><span class="line">                <span class="keyword">if</span> jmp_condition <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                    <span class="comment"># This bb doesn&#x27;t match our pattern skip it</span></span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;BB at <span class="subst">&#123;<span class="built_in">hex</span>(bb_start)&#125;</span> doesn&#x27;t contain cmovl or cmovz, skip it&quot;</span>)</span><br><span class="line">                    ptr = next_head(ptr)</span><br><span class="line">                    <span class="keyword">while</span> <span class="keyword">not</span> is_code(ida_bytes.get_full_flags(ptr)):</span><br><span class="line">                        ptr = next_head(ptr)</span><br><span class="line">                    bb_start = ptr</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">elif</span> first_instruction == <span class="string">&#x27;xor&#x27;</span>:</span><br><span class="line">                <span class="comment"># assume next instruction is the cmp, we should check</span></span><br><span class="line">                ptr_cmp = next_head(bb_start)</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&quot;cmp&quot;</span> != print_insn_mnem(ptr_cmp):</span><br><span class="line">                    <span class="comment"># This bb doesn&#x27;t match our pattern skip it</span></span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;BB at <span class="subst">&#123;<span class="built_in">hex</span>(bb_start)&#125;</span> doesn&#x27;t contain have cmp after xor, skip it&quot;</span>)</span><br><span class="line">                    ptr = next_head(ptr)</span><br><span class="line">                    <span class="keyword">while</span> <span class="keyword">not</span> is_code(ida_bytes.get_full_flags(ptr)):</span><br><span class="line">                        ptr = next_head(ptr)</span><br><span class="line">                    bb_start = ptr</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                eax_cmp_value = get_operand_value(ptr_cmp,<span class="number">1</span>)</span><br><span class="line">                <span class="comment"># Find cmov instruction</span></span><br><span class="line">                bb_ptr = bb_start</span><br><span class="line">                jmp_condition = <span class="literal">None</span></span><br><span class="line">                jmp_condition_address = <span class="literal">None</span></span><br><span class="line">                <span class="keyword">while</span> bb_ptr &lt; ptr:</span><br><span class="line">                    <span class="keyword">if</span> <span class="string">&#x27;setl&#x27;</span> == print_insn_mnem(bb_ptr):</span><br><span class="line">                        jmp_condition = <span class="string">&#x27;setl&#x27;</span></span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">elif</span> <span class="string">&#x27;setz&#x27;</span> == print_insn_mnem(bb_ptr):</span><br><span class="line">                        jmp_condition = <span class="string">&#x27;setz&#x27;</span></span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">elif</span> <span class="string">&#x27;setnz&#x27;</span> == print_insn_mnem(bb_ptr):</span><br><span class="line">                        jmp_condition = <span class="string">&#x27;setnz&#x27;</span></span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    bb_ptr  = next_head(bb_ptr)</span><br><span class="line">                jmp_condition_address = bb_ptr</span><br><span class="line">                <span class="comment"># Check results of cmov find</span></span><br><span class="line">                <span class="keyword">if</span> jmp_condition <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                    <span class="comment"># This bb doesn&#x27;t match our pattern skip it</span></span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;BB at <span class="subst">&#123;<span class="built_in">hex</span>(bb_start)&#125;</span> doesn&#x27;t contain setl or setz, skip it&quot;</span>)</span><br><span class="line">                    ptr = next_head(ptr)</span><br><span class="line">                    <span class="keyword">while</span> <span class="keyword">not</span> is_code(ida_bytes.get_full_flags(ptr)):</span><br><span class="line">                        ptr = next_head(ptr)</span><br><span class="line">                    bb_start = ptr</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># This bb doesn&#x27;t match our pattern skip it</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;BB at <span class="subst">&#123;<span class="built_in">hex</span>(bb_start)&#125;</span> doesn&#x27;t match pattern, skip it&quot;</span>)</span><br><span class="line">                ptr = next_head(ptr)</span><br><span class="line">                <span class="keyword">while</span> <span class="keyword">not</span> is_code(ida_bytes.get_full_flags(ptr)):</span><br><span class="line">                    ptr = next_head(ptr)</span><br><span class="line">                bb_start = ptr</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Dispatcher bb <span class="subst">&#123;<span class="built_in">hex</span>(bb_start)&#125;</span>&quot;</span>)</span><br><span class="line">            bb_table.append((bb_start,ptr,eax_cmp_value,jmp_condition,jmp_condition_address,reg_name))</span><br><span class="line">            ptr = next_head(ptr)</span><br><span class="line">            <span class="keyword">while</span> <span class="keyword">not</span> is_code(ida_bytes.get_full_flags(ptr)):</span><br><span class="line">                ptr = next_head(ptr)</span><br><span class="line">            bb_start = ptr</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># This is code bb don&#x27;t save it</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Original code bb <span class="subst">&#123;<span class="built_in">hex</span>(bb_start)&#125;</span>&quot;</span>)</span><br><span class="line">            bb_orig_table.append(bb_start)</span><br><span class="line">            ptr = next_head(ptr)</span><br><span class="line">            <span class="keyword">while</span> <span class="keyword">not</span> is_code(ida_bytes.get_full_flags(ptr)):</span><br><span class="line">                ptr = next_head(ptr)</span><br><span class="line">            bb_start = ptr</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ptr = next_head(ptr)</span><br><span class="line"></span><br><span class="line">bb_orig_table = [<span class="number">0x7ff6654a687f</span>, <span class="number">0x7ff6654a691a</span>, <span class="number">0x7ff6654a6a04</span>, <span class="number">0x7ff6654a6a84</span>, <span class="number">0x7ff6654a6ad1</span>, <span class="number">0x7ff6654a6b3b</span>, <span class="number">0x7ff6654a6b9b</span>, <span class="number">0x7ff6654a6bf3</span>, <span class="number">0x7ff6654a6c61</span>, <span class="number">0x7ff6654a6cfd</span>, <span class="number">0x7ff6654a6e9f</span>, <span class="number">0x7ff6654a6ef8</span>, <span class="number">0x7ff6654a6f58</span>, <span class="number">0x7ff6654a7024</span>]</span><br><span class="line"></span><br><span class="line">bb_table = [(<span class="number">0x7ff6654a67f0</span>, <span class="number">0x7ff6654a6817</span>, <span class="number">0x10bc6c78</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">0x7ff6654a67fa</span>, <span class="string">&#x27;rdx&#x27;</span>), (<span class="number">0x7ff6654a6819</span>, <span class="number">0x7ff6654a682e</span>, <span class="number">0xffffffffc30bae2e</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">0x7ff6654a6823</span>, <span class="string">&#x27;rdx&#x27;</span>), (<span class="number">0x7ff6654a6830</span>, <span class="number">0x7ff6654a6845</span>, <span class="number">0xffffffffa2992627</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">0x7ff6654a683a</span>, <span class="string">&#x27;rdx&#x27;</span>), (<span class="number">0x7ff6654a6847</span>, <span class="number">0x7ff6654a6861</span>, <span class="number">0xffffffffa22a16af</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">0x7ff6654a6856</span>, <span class="string">&#x27;rdx&#x27;</span>), (<span class="number">0x7ff6654a6863</span>, <span class="number">0x7ff6654a687d</span>, <span class="number">0xffffffff8cbc0434</span>, <span class="string">&#x27;cmovz&#x27;</span>, <span class="number">0x7ff6654a6872</span>, <span class="string">&#x27;rcx&#x27;</span>), (<span class="number">0x7ff6654a68b0</span>, <span class="number">0x7ff6654a68c5</span>, <span class="number">0x6c249751</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">0x7ff6654a68ba</span>, <span class="string">&#x27;rdx&#x27;</span>), (<span class="number">0x7ff6654a68c7</span>, <span class="number">0x7ff6654a68e1</span>, <span class="number">0x3b2b8a1e</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">0x7ff6654a68d6</span>, <span class="string">&#x27;rdx&#x27;</span>), (<span class="number">0x7ff6654a68e3</span>, <span class="number">0x7ff6654a68fd</span>, <span class="number">0x173ba5e1</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">0x7ff6654a68f2</span>, <span class="string">&#x27;rdx&#x27;</span>), (<span class="number">0x7ff6654a68ff</span>, <span class="number">0x7ff6654a6918</span>, <span class="number">0x10bc6c78</span>, <span class="string">&#x27;setz&#x27;</span>, <span class="number">0x7ff6654a6906</span>, <span class="string">&#x27;rcx&#x27;</span>), (<span class="number">0x7ff6654a69b0</span>, <span class="number">0x7ff6654a69ca</span>, <span class="number">0xffffffffd43fb344</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">0x7ff6654a69bf</span>, <span class="string">&#x27;rdx&#x27;</span>), (<span class="number">0x7ff6654a69cc</span>, <span class="number">0x7ff6654a69e6</span>, <span class="number">0xffffffffcef7092e</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">0x7ff6654a69db</span>, <span class="string">&#x27;rdx&#x27;</span>), (<span class="number">0x7ff6654a69e8</span>, <span class="number">0x7ff6654a6a02</span>, <span class="number">0xffffffffc30bae2e</span>, <span class="string">&#x27;cmovz&#x27;</span>, <span class="number">0x7ff6654a69f7</span>, <span class="string">&#x27;rcx&#x27;</span>), (<span class="number">0x7ff6654a6a30</span>, <span class="number">0x7ff6654a6a4a</span>, <span class="number">0x7d71a1e3</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">0x7ff6654a6a3f</span>, <span class="string">&#x27;rdx&#x27;</span>), (<span class="number">0x7ff6654a6a4c</span>, <span class="number">0x7ff6654a6a66</span>, <span class="number">0x7a980236</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">0x7ff6654a6a5b</span>, <span class="string">&#x27;rdx&#x27;</span>), (<span class="number">0x7ff6654a6a68</span>, <span class="number">0x7ff6654a6a82</span>, <span class="number">0x6c249751</span>, <span class="string">&#x27;cmovz&#x27;</span>, <span class="number">0x7ff6654a6a77</span>, <span class="string">&#x27;rcx&#x27;</span>), (<span class="number">0x7ff6654a6a99</span>, <span class="number">0x7ff6654a6ab3</span>, <span class="number">0xffffffffc094d6c9</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">0x7ff6654a6aa8</span>, <span class="string">&#x27;rdx&#x27;</span>), (<span class="number">0x7ff6654a6ab5</span>, <span class="number">0x7ff6654a6acf</span>, <span class="number">0xffffffffa2992627</span>, <span class="string">&#x27;cmovz&#x27;</span>, <span class="number">0x7ff6654a6ac4</span>, <span class="string">&#x27;rcx&#x27;</span>), (<span class="number">0x7ff6654a6b09</span>, <span class="number">0x7ff6654a6b1e</span>, <span class="number">0x3cd69d30</span>, <span class="string">&#x27;setl&#x27;</span>, <span class="number">0x7ff6654a6b10</span>, <span class="string">&#x27;rdx&#x27;</span>), (<span class="number">0x7ff6654a6b20</span>, <span class="number">0x7ff6654a6b39</span>, <span class="number">0x3b2b8a1e</span>, <span class="string">&#x27;setnz&#x27;</span>, <span class="number">0x7ff6654a6b27</span>, <span class="string">&#x27;rcx&#x27;</span>), (<span class="number">0x7ff6654a6b63</span>, <span class="number">0x7ff6654a6b7d</span>, <span class="number">0xffffffffecce8ff1</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">0x7ff6654a6b72</span>, <span class="string">&#x27;rdx&#x27;</span>), (<span class="number">0x7ff6654a6b7f</span>, <span class="number">0x7ff6654a6b99</span>, <span class="number">0xffffffffd43fb344</span>, <span class="string">&#x27;cmovz&#x27;</span>, <span class="number">0x7ff6654a6b8e</span>, <span class="string">&#x27;rcx&#x27;</span>), (<span class="number">0x7ff6654a6bbb</span>, <span class="number">0x7ff6654a6bd5</span>, <span class="number">0x7d9d86f3</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">0x7ff6654a6bca</span>, <span class="string">&#x27;rdx&#x27;</span>), (<span class="number">0x7ff6654a6bd7</span>, <span class="number">0x7ff6654a6bf1</span>, <span class="number">0x7d71a1e3</span>, <span class="string">&#x27;cmovz&#x27;</span>, <span class="number">0x7ff6654a6be6</span>, <span class="string">&#x27;rcx&#x27;</span>), (<span class="number">0x7ff6654a6c45</span>, <span class="number">0x7ff6654a6c5f</span>, <span class="number">0xffffffffa22a16af</span>, <span class="string">&#x27;cmovz&#x27;</span>, <span class="number">0x7ff6654a6c54</span>, <span class="string">&#x27;rcx&#x27;</span>), (<span class="number">0x7ff6654a6ce1</span>, <span class="number">0x7ff6654a6cfb</span>, <span class="number">0x173ba5e1</span>, <span class="string">&#x27;cmovz&#x27;</span>, <span class="number">0x7ff6654a6cf0</span>, <span class="string">&#x27;rcx&#x27;</span>), (<span class="number">0x7ff6654a6e83</span>, <span class="number">0x7ff6654a6e9d</span>, <span class="number">0xffffffffcef7092e</span>, <span class="string">&#x27;cmovz&#x27;</span>, <span class="number">0x7ff6654a6e92</span>, <span class="string">&#x27;rcx&#x27;</span>), (<span class="number">0x7ff6654a6edc</span>, <span class="number">0x7ff6654a6ef6</span>, <span class="number">0x7a980236</span>, <span class="string">&#x27;cmovz&#x27;</span>, <span class="number">0x7ff6654a6eeb</span>, <span class="string">&#x27;rcx&#x27;</span>), (<span class="number">0x7ff6654a6f3d</span>, <span class="number">0x7ff6654a6f56</span>, <span class="number">0xffffffffc094d6c9</span>, <span class="string">&#x27;setz&#x27;</span>, <span class="number">0x7ff6654a6f44</span>, <span class="string">&#x27;rcx&#x27;</span>), (<span class="number">0x7ff6654a7008</span>, <span class="number">0x7ff6654a7022</span>, <span class="number">0x3cd69d30</span>, <span class="string">&#x27;cmovz&#x27;</span>, <span class="number">0x7ff6654a7017</span>, <span class="string">&#x27;rcx&#x27;</span>), (<span class="number">0x7ff6654a7052</span>, <span class="number">0x7ff6654a706c</span>, <span class="number">0xffffffffecce8ff1</span>, <span class="string">&#x27;cmovz&#x27;</span>, <span class="number">0x7ff6654a7061</span>, <span class="string">&#x27;rcx&#x27;</span>)]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>bb_table means the Dispatcher bb, and this bb has two formats that uses (cmovl, cmovz)  or uses (setl and setz)</p>
<p>bb_orig_table means the origin payload bb</p>
</blockquote>
<h3 id="Emulate-Basic-Blocks"><a href="#Emulate-Basic-Blocks" class="headerlink" title="Emulate Basic Blocks"></a>Emulate Basic Blocks</h3><p>For each dispatcher bb emulate the block both satisfying the condition and not satisfying it to produce both the jmp address for the conditional jmp and the jmp address for the unconditional jmp.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">DUMP_FILE = <span class="string">&#x27;13.25.dmp&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> dumpulator <span class="keyword">import</span> Dumpulator</span><br><span class="line"></span><br><span class="line">dp = Dumpulator(DUMP_FILE,quiet=<span class="literal">True</span>)</span><br><span class="line">bb_table = [(<span class="number">0x7ff6654a67f0</span>, <span class="number">0x7ff6654a6817</span>, <span class="number">0x10bc6c78</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">0x7ff6654a67fa</span>, <span class="string">&#x27;rdx&#x27;</span>), (<span class="number">0x7ff6654a6819</span>, <span class="number">0x7ff6654a682e</span>, <span class="number">0xffffffffc30bae2e</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">0x7ff6654a6823</span>, <span class="string">&#x27;rdx&#x27;</span>), (<span class="number">0x7ff6654a6830</span>, <span class="number">0x7ff6654a6845</span>, <span class="number">0xffffffffa2992627</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">0x7ff6654a683a</span>, <span class="string">&#x27;rdx&#x27;</span>), (<span class="number">0x7ff6654a6847</span>, <span class="number">0x7ff6654a6861</span>, <span class="number">0xffffffffa22a16af</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">0x7ff6654a6856</span>, <span class="string">&#x27;rdx&#x27;</span>), (<span class="number">0x7ff6654a6863</span>, <span class="number">0x7ff6654a687d</span>, <span class="number">0xffffffff8cbc0434</span>, <span class="string">&#x27;cmovz&#x27;</span>, <span class="number">0x7ff6654a6872</span>, <span class="string">&#x27;rcx&#x27;</span>), (<span class="number">0x7ff6654a68b0</span>, <span class="number">0x7ff6654a68c5</span>, <span class="number">0x6c249751</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">0x7ff6654a68ba</span>, <span class="string">&#x27;rdx&#x27;</span>), (<span class="number">0x7ff6654a68c7</span>, <span class="number">0x7ff6654a68e1</span>, <span class="number">0x3b2b8a1e</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">0x7ff6654a68d6</span>, <span class="string">&#x27;rdx&#x27;</span>), (<span class="number">0x7ff6654a68e3</span>, <span class="number">0x7ff6654a68fd</span>, <span class="number">0x173ba5e1</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">0x7ff6654a68f2</span>, <span class="string">&#x27;rdx&#x27;</span>), (<span class="number">0x7ff6654a68ff</span>, <span class="number">0x7ff6654a6918</span>, <span class="number">0x10bc6c78</span>, <span class="string">&#x27;setz&#x27;</span>, <span class="number">0x7ff6654a6906</span>, <span class="string">&#x27;rcx&#x27;</span>), (<span class="number">0x7ff6654a69b0</span>, <span class="number">0x7ff6654a69ca</span>, <span class="number">0xffffffffd43fb344</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">0x7ff6654a69bf</span>, <span class="string">&#x27;rdx&#x27;</span>), (<span class="number">0x7ff6654a69cc</span>, <span class="number">0x7ff6654a69e6</span>, <span class="number">0xffffffffcef7092e</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">0x7ff6654a69db</span>, <span class="string">&#x27;rdx&#x27;</span>), (<span class="number">0x7ff6654a69e8</span>, <span class="number">0x7ff6654a6a02</span>, <span class="number">0xffffffffc30bae2e</span>, <span class="string">&#x27;cmovz&#x27;</span>, <span class="number">0x7ff6654a69f7</span>, <span class="string">&#x27;rcx&#x27;</span>), (<span class="number">0x7ff6654a6a30</span>, <span class="number">0x7ff6654a6a4a</span>, <span class="number">0x7d71a1e3</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">0x7ff6654a6a3f</span>, <span class="string">&#x27;rdx&#x27;</span>), (<span class="number">0x7ff6654a6a4c</span>, <span class="number">0x7ff6654a6a66</span>, <span class="number">0x7a980236</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">0x7ff6654a6a5b</span>, <span class="string">&#x27;rdx&#x27;</span>), (<span class="number">0x7ff6654a6a68</span>, <span class="number">0x7ff6654a6a82</span>, <span class="number">0x6c249751</span>, <span class="string">&#x27;cmovz&#x27;</span>, <span class="number">0x7ff6654a6a77</span>, <span class="string">&#x27;rcx&#x27;</span>), (<span class="number">0x7ff6654a6a99</span>, <span class="number">0x7ff6654a6ab3</span>, <span class="number">0xffffffffc094d6c9</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">0x7ff6654a6aa8</span>, <span class="string">&#x27;rdx&#x27;</span>), (<span class="number">0x7ff6654a6ab5</span>, <span class="number">0x7ff6654a6acf</span>, <span class="number">0xffffffffa2992627</span>, <span class="string">&#x27;cmovz&#x27;</span>, <span class="number">0x7ff6654a6ac4</span>, <span class="string">&#x27;rcx&#x27;</span>), (<span class="number">0x7ff6654a6b09</span>, <span class="number">0x7ff6654a6b1e</span>, <span class="number">0x3cd69d30</span>, <span class="string">&#x27;setl&#x27;</span>, <span class="number">0x7ff6654a6b10</span>, <span class="string">&#x27;rdx&#x27;</span>), (<span class="number">0x7ff6654a6b20</span>, <span class="number">0x7ff6654a6b39</span>, <span class="number">0x3b2b8a1e</span>, <span class="string">&#x27;setnz&#x27;</span>, <span class="number">0x7ff6654a6b27</span>, <span class="string">&#x27;rcx&#x27;</span>), (<span class="number">0x7ff6654a6b63</span>, <span class="number">0x7ff6654a6b7d</span>, <span class="number">0xffffffffecce8ff1</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">0x7ff6654a6b72</span>, <span class="string">&#x27;rdx&#x27;</span>), (<span class="number">0x7ff6654a6b7f</span>, <span class="number">0x7ff6654a6b99</span>, <span class="number">0xffffffffd43fb344</span>, <span class="string">&#x27;cmovz&#x27;</span>, <span class="number">0x7ff6654a6b8e</span>, <span class="string">&#x27;rcx&#x27;</span>), (<span class="number">0x7ff6654a6bbb</span>, <span class="number">0x7ff6654a6bd5</span>, <span class="number">0x7d9d86f3</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">0x7ff6654a6bca</span>, <span class="string">&#x27;rdx&#x27;</span>), (<span class="number">0x7ff6654a6bd7</span>, <span class="number">0x7ff6654a6bf1</span>, <span class="number">0x7d71a1e3</span>, <span class="string">&#x27;cmovz&#x27;</span>, <span class="number">0x7ff6654a6be6</span>, <span class="string">&#x27;rcx&#x27;</span>), (<span class="number">0x7ff6654a6c45</span>, <span class="number">0x7ff6654a6c5f</span>, <span class="number">0xffffffffa22a16af</span>, <span class="string">&#x27;cmovz&#x27;</span>, <span class="number">0x7ff6654a6c54</span>, <span class="string">&#x27;rcx&#x27;</span>), (<span class="number">0x7ff6654a6ce1</span>, <span class="number">0x7ff6654a6cfb</span>, <span class="number">0x173ba5e1</span>, <span class="string">&#x27;cmovz&#x27;</span>, <span class="number">0x7ff6654a6cf0</span>, <span class="string">&#x27;rcx&#x27;</span>), (<span class="number">0x7ff6654a6e83</span>, <span class="number">0x7ff6654a6e9d</span>, <span class="number">0xffffffffcef7092e</span>, <span class="string">&#x27;cmovz&#x27;</span>, <span class="number">0x7ff6654a6e92</span>, <span class="string">&#x27;rcx&#x27;</span>), (<span class="number">0x7ff6654a6edc</span>, <span class="number">0x7ff6654a6ef6</span>, <span class="number">0x7a980236</span>, <span class="string">&#x27;cmovz&#x27;</span>, <span class="number">0x7ff6654a6eeb</span>, <span class="string">&#x27;rcx&#x27;</span>), (<span class="number">0x7ff6654a6f3d</span>, <span class="number">0x7ff6654a6f56</span>, <span class="number">0xffffffffc094d6c9</span>, <span class="string">&#x27;setz&#x27;</span>, <span class="number">0x7ff6654a6f44</span>, <span class="string">&#x27;rcx&#x27;</span>), (<span class="number">0x7ff6654a7008</span>, <span class="number">0x7ff6654a7022</span>, <span class="number">0x3cd69d30</span>, <span class="string">&#x27;cmovz&#x27;</span>, <span class="number">0x7ff6654a7017</span>, <span class="string">&#x27;rcx&#x27;</span>), (<span class="number">0x7ff6654a7052</span>, <span class="number">0x7ff6654a706c</span>, <span class="number">0xffffffffecce8ff1</span>, <span class="string">&#x27;cmovz&#x27;</span>, <span class="number">0x7ff6654a7061</span>, <span class="string">&#x27;rcx&#x27;</span>)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bb_jmp_table = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">emulate_bb</span>(<span class="params">bb_start, bb_end, eax_value, jmp_reg</span>):</span><br><span class="line">    dp.regs.eflags = <span class="number">0</span></span><br><span class="line">    dp.regs.r15 = <span class="number">0x190</span></span><br><span class="line">    dp.regs.r14 = <span class="number">0x0FFFFFFFFAE6529F8</span></span><br><span class="line">    dp.regs.r13 = <span class="number">0x10</span></span><br><span class="line">    dp.regs.r12 = <span class="number">0x1B0</span></span><br><span class="line">    dp.regs.rcx = <span class="number">0x00007FF6654A6CFD</span></span><br><span class="line">    dp.regs.rax = eax_value</span><br><span class="line">    dp.start(bb_start,end=bb_end)</span><br><span class="line">    jmp_reg_value = dp.regs.__getattr__(jmp_reg)</span><br><span class="line">    <span class="keyword">return</span> jmp_reg_value</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> bb <span class="keyword">in</span> bb_table:</span><br><span class="line">    bb_start = bb[<span class="number">0</span>]</span><br><span class="line">    bb_end = bb[<span class="number">1</span>]</span><br><span class="line">    eax_value = bb[<span class="number">2</span>]</span><br><span class="line">    jmp_condition = bb[<span class="number">3</span>]</span><br><span class="line">    jmp_condition_address = bb[<span class="number">4</span>]</span><br><span class="line">    jmp_register = bb[<span class="number">5</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># plus or minus the eax_value is used to satisfied the asm code, so that we can get the jmp address</span></span><br><span class="line">    <span class="keyword">if</span> jmp_condition == <span class="string">&#x27;cmovl&#x27;</span> <span class="keyword">or</span> jmp_condition == <span class="string">&#x27;setl&#x27;</span>:</span><br><span class="line">        jmp_addr_satisfied = emulate_bb(bb_start, bb_end, eax_value - <span class="number">1</span>, jmp_register)</span><br><span class="line">        jmp_addr_unsatisfied = emulate_bb(bb_start, bb_end, eax_value + <span class="number">1</span>, jmp_register)</span><br><span class="line">    <span class="keyword">elif</span> jmp_condition == <span class="string">&#x27;cmovz&#x27;</span> <span class="keyword">or</span> jmp_condition == <span class="string">&#x27;setz&#x27;</span>:</span><br><span class="line">        jmp_addr_satisfied = emulate_bb(bb_start, bb_end, eax_value, jmp_register)</span><br><span class="line">        jmp_addr_unsatisfied = emulate_bb(bb_start, bb_end, eax_value + <span class="number">1</span>, jmp_register)</span><br><span class="line">    <span class="keyword">elif</span> jmp_condition == <span class="string">&#x27;setnz&#x27;</span>:</span><br><span class="line">        jmp_addr_satisfied = emulate_bb(bb_start, bb_end, eax_value + <span class="number">1</span>, jmp_register)</span><br><span class="line">        jmp_addr_unsatisfied = emulate_bb(bb_start, bb_end, eax_value, jmp_register)</span><br><span class="line">        </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;BB <span class="subst">&#123;<span class="built_in">hex</span>(bb_start)&#125;</span>:<span class="subst">&#123;<span class="built_in">hex</span>(bb_end)&#125;</span> - jmp_addr_satisfied: <span class="subst">&#123;<span class="built_in">hex</span>(jmp_addr_satisfied)&#125;</span> - jmp_addr_unsatisfied: <span class="subst">&#123;<span class="built_in">hex</span>(jmp_addr_unsatisfied)&#125;</span>&quot;</span>)</span><br><span class="line">    bb_jmp_table.append((bb_start,bb_end,eax_value,jmp_condition,jmp_condition_address,jmp_register,jmp_addr_satisfied,jmp_addr_unsatisfied))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> bb <span class="keyword">in</span> bb_jmp_table:</span><br><span class="line">    <span class="built_in">print</span>(bb)</span><br></pre></td></tr></table></figure>

<h3 id="ida-patch"><a href="#ida-patch" class="headerlink" title="ida patch"></a>ida patch</h3><p>conditions</p>
<ul>
<li>cmovl setl————jl</li>
<li>cmovz setz————jz</li>
<li>setnz————jnz</li>
</ul>
<p>so why this???</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cmovl   rdx, r12        ; Move if Less (SF!=OF)</span><br><span class="line">cmovz   rdx, rbp        ; Move if Zero (ZF=1)</span><br><span class="line">setz    dl              ; Set Byte if Zero (ZF=1)</span><br><span class="line">setl    dl              ; Set Byte if Less (SF!=OF)</span><br><span class="line">setnz   dl              ; Set Byte if Not Zero (ZF=0)</span><br></pre></td></tr></table></figure>

<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20220413170752647-20220413175813710.png" alt="image-20220413170752647"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct </span><br><span class="line"></span><br><span class="line">bb_jmp_table = [(<span class="number">140696238057456</span>, <span class="number">140696238057495</span>, <span class="number">280783992</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">140696238057466</span>, <span class="string">&#x27;rdx&#x27;</span>, <span class="number">140696238057497</span>, <span class="number">140696238057648</span>), (<span class="number">140696238057497</span>, <span class="number">140696238057518</span>, <span class="number">18446744072686906926</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">140696238057507</span>, <span class="string">&#x27;rdx&#x27;</span>, <span class="number">140696238057520</span>, <span class="number">140696238057904</span>), (<span class="number">140696238057520</span>, <span class="number">140696238057541</span>, <span class="number">18446744072142530087</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">140696238057530</span>, <span class="string">&#x27;rdx&#x27;</span>, <span class="number">140696238057543</span>, <span class="number">140696238058137</span>), (<span class="number">140696238057543</span>, <span class="number">140696238057569</span>, <span class="number">18446744072135251631</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">140696238057558</span>, <span class="string">&#x27;rdx&#x27;</span>, <span class="number">140696238057571</span>, <span class="number">140696238058565</span>), (<span class="number">140696238057571</span>, <span class="number">140696238057597</span>, <span class="number">18446744071775716404</span>, <span class="string">&#x27;cmovz&#x27;</span>, <span class="number">140696238057586</span>, <span class="string">&#x27;rcx&#x27;</span>, <span class="number">140696238057599</span>, <span class="number">140696238057456</span>), (<span class="number">140696238057648</span>, <span class="number">140696238057669</span>, <span class="number">1814337361</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">140696238057658</span>, <span class="string">&#x27;rdx&#x27;</span>, <span class="number">140696238057671</span>, <span class="number">140696238058032</span>), (<span class="number">140696238057671</span>, <span class="number">140696238057697</span>, <span class="number">992709150</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">140696238057686</span>, <span class="string">&#x27;rdx&#x27;</span>, <span class="number">140696238057699</span>, <span class="number">140696238058249</span>), (<span class="number">140696238057699</span>, <span class="number">140696238057725</span>, <span class="number">389785057</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">140696238057714</span>, <span class="string">&#x27;rdx&#x27;</span>, <span class="number">140696238057727</span>, <span class="number">140696238058721</span>), (<span class="number">140696238057727</span>, <span class="number">140696238057752</span>, <span class="number">280783992</span>, <span class="string">&#x27;setz&#x27;</span>, <span class="number">140696238057734</span>, <span class="string">&#x27;rcx&#x27;</span>, <span class="number">140696238057754</span>, <span class="number">140696238057456</span>), (<span class="number">140696238057904</span>, <span class="number">140696238057930</span>, <span class="number">18446744072975528772</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">140696238057919</span>, <span class="string">&#x27;rdx&#x27;</span>, <span class="number">140696238057932</span>, <span class="number">140696238058339</span>), (<span class="number">140696238057932</span>, <span class="number">140696238057958</span>, <span class="number">18446744072886880558</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">140696238057947</span>, <span class="string">&#x27;rdx&#x27;</span>, <span class="number">140696238057960</span>, <span class="number">140696238059139</span>), (<span class="number">140696238057960</span>, <span class="number">140696238057986</span>, <span class="number">18446744072686906926</span>, <span class="string">&#x27;cmovz&#x27;</span>, <span class="number">140696238057975</span>, <span class="string">&#x27;rcx&#x27;</span>, <span class="number">140696238057988</span>, <span class="number">140696238057456</span>), (<span class="number">140696238058032</span>, <span class="number">140696238058058</span>, <span class="number">2104599011</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">140696238058047</span>, <span class="string">&#x27;rdx&#x27;</span>, <span class="number">140696238058060</span>, <span class="number">140696238058427</span>), (<span class="number">140696238058060</span>, <span class="number">140696238058086</span>, <span class="number">2056782390</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">140696238058075</span>, <span class="string">&#x27;rdx&#x27;</span>, <span class="number">140696238058088</span>, <span class="number">140696238059228</span>), (<span class="number">140696238058088</span>, <span class="number">140696238058114</span>, <span class="number">1814337361</span>, <span class="string">&#x27;cmovz&#x27;</span>, <span class="number">140696238058103</span>, <span class="string">&#x27;rcx&#x27;</span>, <span class="number">140696238058116</span>, <span class="number">140696238057456</span>), (<span class="number">140696238058137</span>, <span class="number">140696238058163</span>, <span class="number">18446744072645564105</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">140696238058152</span>, <span class="string">&#x27;rdx&#x27;</span>, <span class="number">140696238058165</span>, <span class="number">140696238059325</span>), (<span class="number">140696238058165</span>, <span class="number">140696238058191</span>, <span class="number">18446744072142530087</span>, <span class="string">&#x27;cmovz&#x27;</span>, <span class="number">140696238058180</span>, <span class="string">&#x27;rcx&#x27;</span>, <span class="number">140696238058193</span>, <span class="number">140696238057456</span>), (<span class="number">140696238058249</span>, <span class="number">140696238058270</span>, <span class="number">1020697904</span>, <span class="string">&#x27;setl&#x27;</span>, <span class="number">140696238058256</span>, <span class="string">&#x27;rdx&#x27;</span>, <span class="number">140696238058272</span>, <span class="number">140696238059528</span>), (<span class="number">140696238058272</span>, <span class="number">140696238058297</span>, <span class="number">992709150</span>, <span class="string">&#x27;setnz&#x27;</span>, <span class="number">140696238058279</span>, <span class="string">&#x27;rcx&#x27;</span>, <span class="number">140696238057456</span>, <span class="number">140696238058299</span>), (<span class="number">140696238058339</span>, <span class="number">140696238058365</span>, <span class="number">18446744073387544561</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">140696238058354</span>, <span class="string">&#x27;rdx&#x27;</span>, <span class="number">140696238058367</span>, <span class="number">140696238059602</span>), (<span class="number">140696238058367</span>, <span class="number">140696238058393</span>, <span class="number">18446744072975528772</span>, <span class="string">&#x27;cmovz&#x27;</span>, <span class="number">140696238058382</span>, <span class="string">&#x27;rcx&#x27;</span>, <span class="number">140696238058395</span>, <span class="number">140696238057456</span>), (<span class="number">140696238058427</span>, <span class="number">140696238058453</span>, <span class="number">2107475699</span>, <span class="string">&#x27;cmovl&#x27;</span>, <span class="number">140696238058442</span>, <span class="string">&#x27;rdx&#x27;</span>, <span class="number">140696238058455</span>, <span class="number">140696238057416</span>), (<span class="number">140696238058455</span>, <span class="number">140696238058481</span>, <span class="number">2104599011</span>, <span class="string">&#x27;cmovz&#x27;</span>, <span class="number">140696238058470</span>, <span class="string">&#x27;rcx&#x27;</span>, <span class="number">140696238058483</span>, <span class="number">140696238057456</span>), (<span class="number">140696238058565</span>, <span class="number">140696238058591</span>, <span class="number">18446744072135251631</span>, <span class="string">&#x27;cmovz&#x27;</span>, <span class="number">140696238058580</span>, <span class="string">&#x27;rcx&#x27;</span>, <span class="number">140696238058593</span>, <span class="number">140696238057456</span>), (<span class="number">140696238058721</span>, <span class="number">140696238058747</span>, <span class="number">389785057</span>, <span class="string">&#x27;cmovz&#x27;</span>, <span class="number">140696238058736</span>, <span class="string">&#x27;rcx&#x27;</span>, <span class="number">140696238058749</span>, <span class="number">140696238057456</span>), (<span class="number">140696238059139</span>, <span class="number">140696238059165</span>, <span class="number">18446744072886880558</span>, <span class="string">&#x27;cmovz&#x27;</span>, <span class="number">140696238059154</span>, <span class="string">&#x27;rcx&#x27;</span>, <span class="number">140696238059167</span>, <span class="number">140696238057456</span>), (<span class="number">140696238059228</span>, <span class="number">140696238059254</span>, <span class="number">2056782390</span>, <span class="string">&#x27;cmovz&#x27;</span>, <span class="number">140696238059243</span>, <span class="string">&#x27;rcx&#x27;</span>, <span class="number">140696238059256</span>, <span class="number">140696238057456</span>), (<span class="number">140696238059325</span>, <span class="number">140696238059350</span>, <span class="number">18446744072645564105</span>, <span class="string">&#x27;setz&#x27;</span>, <span class="number">140696238059332</span>, <span class="string">&#x27;rcx&#x27;</span>, <span class="number">140696238059352</span>, <span class="number">140696238057456</span>), (<span class="number">140696238059528</span>, <span class="number">140696238059554</span>, <span class="number">1020697904</span>, <span class="string">&#x27;cmovz&#x27;</span>, <span class="number">140696238059543</span>, <span class="string">&#x27;rcx&#x27;</span>, <span class="number">140696238059556</span>, <span class="number">140696238057456</span>), (<span class="number">140696238059602</span>, <span class="number">140696238059628</span>, <span class="number">18446744073387544561</span>, <span class="string">&#x27;cmovz&#x27;</span>, <span class="number">140696238059617</span>, <span class="string">&#x27;rcx&#x27;</span>, <span class="number">140696238059630</span>, <span class="number">140696238057456</span>)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> bb <span class="keyword">in</span> bb_jmp_table:</span><br><span class="line">    bb_start = bb[<span class="number">0</span>]</span><br><span class="line">    bb_end = bb[<span class="number">1</span>]</span><br><span class="line">    eax_value = bb[<span class="number">2</span>]</span><br><span class="line">    jmp_condition = bb[<span class="number">3</span>]</span><br><span class="line">    jmp_condition_address = bb[<span class="number">4</span>]</span><br><span class="line">    jmp_register = bb[<span class="number">5</span>]</span><br><span class="line">    jmp_addr_satisfied = bb[<span class="number">6</span>]</span><br><span class="line">    jmp_addr_unsatisfied = bb[<span class="number">7</span>]</span><br><span class="line"></span><br><span class="line">    patch_jmp_cond_start = jmp_condition_address</span><br><span class="line">    jmp_rel_statisfied =  jmp_addr_satisfied - (patch_jmp_cond_start + <span class="number">6</span>)  <span class="comment">#jz jnz jl address that satisfied the cmp eax,xxxxxx</span></span><br><span class="line">    </span><br><span class="line">    patch_jmp_start = patch_jmp_cond_start + <span class="number">6</span> <span class="comment"># long jump need 6 byte ,jmp need 5 byte  </span></span><br><span class="line">    jmp_rel =  jmp_addr_unsatisfied - (patch_jmp_start + <span class="number">5</span>) <span class="comment"># jmp relative address</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> jmp_condition == <span class="string">&#x27;cmovl&#x27;</span> <span class="keyword">or</span> jmp_condition == <span class="string">&#x27;setl&#x27;</span>:</span><br><span class="line">        <span class="comment"># jl</span></span><br><span class="line">        patch_jmp_condition = <span class="string">b&#x27;\x0f\x8c&#x27;</span> +  struct.pack(<span class="string">&#x27;&lt;i&#x27;</span>,jmp_rel_statisfied)</span><br><span class="line">        patch_jmp = <span class="string">b&#x27;\xe9&#x27;</span> +  struct.pack(<span class="string">&#x27;&lt;i&#x27;</span>,jmp_rel)</span><br><span class="line">    <span class="keyword">elif</span> jmp_condition == <span class="string">&#x27;cmovz&#x27;</span> <span class="keyword">or</span> jmp_condition == <span class="string">&#x27;setz&#x27;</span>:</span><br><span class="line">        <span class="comment"># jz</span></span><br><span class="line">        patch_jmp_condition = <span class="string">b&#x27;\x0f\x84&#x27;</span> +  struct.pack(<span class="string">&#x27;&lt;i&#x27;</span>,jmp_rel_statisfied)</span><br><span class="line">        patch_jmp = <span class="string">b&#x27;\xe9&#x27;</span> +  struct.pack(<span class="string">&#x27;&lt;i&#x27;</span>,jmp_rel)</span><br><span class="line">    <span class="keyword">elif</span> jmp_condition == <span class="string">&#x27;setnz&#x27;</span>:</span><br><span class="line">        <span class="comment"># jnz</span></span><br><span class="line">        patch_jmp_condition = <span class="string">b&#x27;\x0f\x85&#x27;</span> +  struct.pack(<span class="string">&#x27;&lt;i&#x27;</span>,jmp_rel_statisfied)</span><br><span class="line">        patch_jmp = <span class="string">b&#x27;\xe9&#x27;</span> +  struct.pack(<span class="string">&#x27;&lt;i&#x27;</span>,jmp_rel)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># calculat nops for end of patch</span></span><br><span class="line">    total_bytes = bb_end - jmp_condition_address + <span class="number">2</span></span><br><span class="line">    nop_count = total_bytes - <span class="number">11</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 11 bytes for the patch + nops to fill space</span></span><br><span class="line">    patch_bytes = patch_jmp_condition + patch_jmp + <span class="string">b&#x27;\x90&#x27;</span>* nop_count</span><br><span class="line"></span><br><span class="line">    <span class="comment"># patch the bytes</span></span><br><span class="line">    patch_ptr = jmp_condition_address</span><br><span class="line"></span><br><span class="line">    <span class="comment"># print(&quot;ggod&quot;)</span></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> patch_bytes:</span><br><span class="line">        patch_byte(patch_ptr, c)</span><br><span class="line">        patch_ptr += <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h3 id="analysis"><a href="#analysis" class="headerlink" title="analysis"></a>analysis</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(hex(patch_jmp_cond_start),hex(jmp_rel_statisfied),hex(patch_jmp_start),hex(jmp_rel))</span><br></pre></td></tr></table></figure>

<p>output beblow</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">patch_jmp_cond_start jmp_rel_statisfied patch_jmp_start   jmp_rel</span><br><span class="line"><span class="number">0x7ff6654a67fa</span>       <span class="number">0x19</span>               <span class="number">0x7ff6654a6800</span>    <span class="number">0xab</span></span><br><span class="line"><span class="number">0x7ff6654a6823</span>       <span class="number">0x7</span>                <span class="number">0x7ff6654a6829</span>    <span class="number">0x182</span></span><br><span class="line"><span class="number">0x7ff6654a683a</span>       <span class="number">0x7</span>                <span class="number">0x7ff6654a6840</span>    <span class="number">0x254</span></span><br><span class="line"><span class="number">0x7ff6654a6856</span>       <span class="number">0x7</span>                <span class="number">0x7ff6654a685c</span>    <span class="number">0x3e4</span></span><br><span class="line"><span class="number">0x7ff6654a6872</span>       <span class="number">0x7</span>                <span class="number">0x7ff6654a6878</span>    -<span class="number">0x8d</span></span><br><span class="line"><span class="number">0x7ff6654a68ba</span>       <span class="number">0x7</span>                <span class="number">0x7ff6654a68c0</span>    <span class="number">0x16b</span></span><br><span class="line"><span class="number">0x7ff6654a68d6</span>       <span class="number">0x7</span>                <span class="number">0x7ff6654a68dc</span>    <span class="number">0x228</span></span><br><span class="line"><span class="number">0x7ff6654a68f2</span>       <span class="number">0x7</span>                <span class="number">0x7ff6654a68f8</span>    <span class="number">0x3e4</span></span><br><span class="line"><span class="number">0x7ff6654a6906</span>       <span class="number">0xe</span>                <span class="number">0x7ff6654a690c</span>    -<span class="number">0x121</span></span><br><span class="line"><span class="number">0x7ff6654a69bf</span>       <span class="number">0x7</span>                <span class="number">0x7ff6654a69c5</span>    <span class="number">0x199</span></span><br><span class="line"><span class="number">0x7ff6654a69db</span>       <span class="number">0x7</span>                <span class="number">0x7ff6654a69e1</span>    <span class="number">0x49d</span></span><br><span class="line"><span class="number">0x7ff6654a69f7</span>       <span class="number">0x7</span>                <span class="number">0x7ff6654a69fd</span>    -<span class="number">0x212</span></span><br><span class="line"><span class="number">0x7ff6654a6a3f</span>       <span class="number">0x7</span>                <span class="number">0x7ff6654a6a45</span>    <span class="number">0x171</span></span><br><span class="line"><span class="number">0x7ff6654a6a5b</span>       <span class="number">0x7</span>                <span class="number">0x7ff6654a6a61</span>    <span class="number">0x476</span></span><br><span class="line"><span class="number">0x7ff6654a6a77</span>       <span class="number">0x7</span>                <span class="number">0x7ff6654a6a7d</span>    -<span class="number">0x292</span></span><br><span class="line"><span class="number">0x7ff6654a6aa8</span>       <span class="number">0x7</span>                <span class="number">0x7ff6654a6aae</span>    <span class="number">0x48a</span></span><br><span class="line"><span class="number">0x7ff6654a6ac4</span>       <span class="number">0x7</span>                <span class="number">0x7ff6654a6aca</span>    -<span class="number">0x2df</span></span><br><span class="line"><span class="number">0x7ff6654a6b10</span>       <span class="number">0xa</span>                <span class="number">0x7ff6654a6b16</span>    <span class="number">0x4ed</span></span><br><span class="line"><span class="number">0x7ff6654a6b27</span>       -<span class="number">0x33d</span>             <span class="number">0x7ff6654a6b2d</span>    <span class="number">0x9</span></span><br><span class="line"><span class="number">0x7ff6654a6b72</span>       <span class="number">0x7</span>                <span class="number">0x7ff6654a6b78</span>    <span class="number">0x4d5</span></span><br><span class="line"><span class="number">0x7ff6654a6b8e</span>       <span class="number">0x7</span>                <span class="number">0x7ff6654a6b94</span>    -<span class="number">0x3a9</span></span><br><span class="line"><span class="number">0x7ff6654a6bca</span>       <span class="number">0x7</span>                <span class="number">0x7ff6654a6bd0</span>    -<span class="number">0x40d</span></span><br><span class="line"><span class="number">0x7ff6654a6be6</span>       <span class="number">0x7</span>                <span class="number">0x7ff6654a6bec</span>    -<span class="number">0x401</span></span><br><span class="line"><span class="number">0x7ff6654a6c54</span>       <span class="number">0x7</span>                <span class="number">0x7ff6654a6c5a</span>    -<span class="number">0x46f</span></span><br><span class="line"><span class="number">0x7ff6654a6cf0</span>       <span class="number">0x7</span>                <span class="number">0x7ff6654a6cf6</span>    -<span class="number">0x50b</span></span><br><span class="line"><span class="number">0x7ff6654a6e92</span>       <span class="number">0x7</span>                <span class="number">0x7ff6654a6e98</span>    -<span class="number">0x6ad</span></span><br><span class="line"><span class="number">0x7ff6654a6eeb</span>       <span class="number">0x7</span>                <span class="number">0x7ff6654a6ef1</span>    -<span class="number">0x706</span></span><br><span class="line"><span class="number">0x7ff6654a6f44</span>       <span class="number">0xe</span>                <span class="number">0x7ff6654a6f4a</span>    -<span class="number">0x75f</span></span><br><span class="line"><span class="number">0x7ff6654a7017</span>       <span class="number">0x7</span>                <span class="number">0x7ff6654a701d</span>    -<span class="number">0x832</span></span><br><span class="line"><span class="number">0x7ff6654a7061</span>       <span class="number">0x7</span>                <span class="number">0x7ff6654a7067</span>    -<span class="number">0x87c</span></span><br><span class="line"></span><br><span class="line">    patch_jmp_cond_start = jmp_condition_address</span><br><span class="line">    jmp_rel_statisfied =  jmp_addr_satisfied - (patch_jmp_cond_start + <span class="number">6</span>)</span><br><span class="line">    patch_jmp_start = patch_jmp_cond_start + <span class="number">6</span></span><br><span class="line">    jmp_rel =  jmp_addr_unsatisfied - (patch_jmp_start + <span class="number">5</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>this means</p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/%E6%88%AA%E5%B1%8F2022-04-13%20%E4%B8%8B%E5%8D%882.14.49-20220413174504994-20220413175821680.png" alt="截屏2022-04-13 下午2.14.49"></p>
</blockquote>
</p><div class="tip">本文采用CC-BY-SA-3.0协议，转载请注明出处<br>Author: scr1pt</div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-04-13</span><i class="fa fa-tag"></i><a class="tag" href="/tags/ollvm-dumpulator-ransomeware/" title="ollvm dumpulator ransomeware">ollvm dumpulator ransomeware </a><span class="leancloud_visitors"></span><span>About 3456 words, 11 min 31 sec  read</span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://Scr1pt-kid.github.io/2022/04/13/Pandora-Ransomeware-fla-unpack/,scr1pt's blog,Pandora-Ransomeware-fla-unpack,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2022/04/18/anti-hook/" title="anti-hook">Previous</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2022/04/07/calling-convention/" title="calling-convention">Next</a></li></ul></div><script src="/js/visitors.js"></script></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script>(function(window){var INSIGHT_CONFIG={TRANSLATION:{POSTS:"Posts",PAGES:"Pages",CATEGORIES:"Categories",TAGS:"Tags",UNTITLED:"(Untitled)",},CONTENT_URL:"/content.json",};window.INSIGHT_CONFIG=INSIGHT_CONFIG})(window);</script><script src="/js/insight.js" defer></script><div class="searchbox ins-search"><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"><input class="searchbox-input ins-search-input" type="text" placeholder="Search..."><span class="searchbox-close"><a class="fa fa-times-circle" onclick="closeWindow();"></a></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"><p>Seraching...</p></div></div></div></div></body></html>